!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var r in s)("object"==typeof exports?exports:e)[r]=s[r]}}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=19)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PROTO_VERSION="1.1.0",t.ROOMVERSION="V1",function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error",e[e.report=99]="report",e[e.disable=100]="disable"}(t.ENUM_LOG_LEVEL||(t.ENUM_LOG_LEVEL={})),function(e){e[e.disable=0]="disable",e[e.websocket=1]="websocket",e[e.https=2]="https"}(t.ENUM_REMOTE_TYPE||(t.ENUM_REMOTE_TYPE={}));var r=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this._id=null,this.next=null,this.prev=null,this._id=e,this._data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),e.prototype.hasNext=function(){return this.next&&this.next.id},e.prototype.hasPrev=function(){return this.prev&&this.prev.id},e}();t.ListNode=r;var i=function(){function e(){this.start=new r,this.end=new r,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return e.prototype.insertBefore=function(e,t){var s=new r(this._idCounter,t);return s.next=e,s.prev=e.prev,e.prev.next=s,e.prev=s,++this._idCounter,++this._numNodes,s},e.prototype.addLast=function(e){return this.insertBefore(this.end,e)},e.prototype.add=function(e){return this.addLast(e)},e.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},e.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},e.prototype.size=function(){return this._numNodes},e.prototype.getFromFirst=function(e){var t=0,s=this.start.next;if(e>=0)for(;t<e&&null!==s;)s=s.next,++t;else s=null;if(null===s)throw"Index out of bounds.";return s},e.prototype.get=function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},e.prototype.remove=function(e){return e.prev.next=e.next,e.next.prev=e.prev,--this._numNodes,e},e.prototype.removeFirst=function(){var e=null;return this._numNodes>0&&(e=this.remove(this.start.next)),e},e.prototype.removeLast=function(){var e=null;return this._numNodes>0&&(e=this.remove(this.end.prev)),e},e.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},e.prototype.each=function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},e.prototype.find=function(e){for(var t=this.start,s=!1,r=null;t.hasNext()&&!s;)e(t=t.next)&&(r=t,s=!0);return r},e.prototype.map=function(e){for(var t=this.start,s=[];t.hasNext();)e(t=t.next)&&s.push(t);return s},e.prototype.push=function(e){return this.addLast(e)},e.prototype.unshift=function(e){this._numNodes>0?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},e.prototype.pop=function(){return this.removeLast()},e.prototype.shift=function(){return this.removeFirst()},e}();t.LinkedList=i,t.sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},function(e){e[e.disconnected=0]="disconnected",e[e.connecting=1]="connecting",e[e.connected=2]="connected"}(t.ENUM_SIGNAL_STATE||(t.ENUM_SIGNAL_STATE={})),t.ENUM_RESOLUTION_TYPE={LOW:{width:240,height:320,frameRate:15,bitRate:300},MEDIUM:{width:480,height:640,frameRate:15,bitRate:800},HIGH:{width:720,height:1280,frameRate:20,bitRate:1500}},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},t.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},t.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},t.MAX_TRY_CONNECT_COUNT=3,t.SEND_MSG_RESET=2,t.SEND_MSG_TIMEOUT=1,t.MAX_TRY_HEARTBEAT_COUNT=5,t.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5},t.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},t.ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},function(e){e[e.logout=0]="logout",e[e.trylogin=1]="trylogin",e[e.login=2]="login"}(t.ENUM_RUN_STATE||(t.ENUM_RUN_STATE={})),t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2},t.MAX_TRY_LOGIN_COUNT=5,t.TRY_LOGIN_INTERVAL=[2e3,2e3,3e3,3e3,4e3],t.MINIUM_HEARTBEAT_INTERVAL=3e3,t.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},t.SERVER_ERROR_CODE=1e4,t.MIXSTREAM_ERROR_CODE=1e4,function(e){e[e.low=1]="low",e[e.stantard=2]="stantard",e[e.hight=3]="hight",e[e.custome=4]="custome"}(t.QUALITYLEVEL||(t.QUALITYLEVEL={})),t.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},t.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},function(e){e[e.auto=0]="auto",e[e.ultra=1]="ultra"}(t.ENUM_PLAY_SOURCE_TYPE||(t.ENUM_PLAY_SOURCE_TYPE={})),function(e){e[e.cdn=0]="cdn",e[e.ultra=1]="ultra",e[e.customUrl=2]="customUrl"}(t.ENUM_DISPATCH_TYPE||(t.ENUM_DISPATCH_TYPE={})),function(e){e[e.ClientType_None=0]="ClientType_None",e[e.ClientType_H5=1]="ClientType_H5",e[e.ClientType_SmallPragram=2]="ClientType_SmallPragram",e[e.ClientType_Webrtc=3]="ClientType_Webrtc"}(t.E_CLIENT_TYPE||(t.E_CLIENT_TYPE={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.checkConfigParam=function(e,t){return e.appid&&"number"==typeof e.appid?e.server?!(!e.idName||"string"!=typeof e.idName)||(t.error("ccp.0 idName must be string and not empty"),!1):(t.error("ccp.0 server must be string and not empty"),!1):(t.error("ccp.0 appid must be number"),!1)},e.checkLoginParam=function(e,t){return!0},e.registerCallback=function(e,t,s){var r,i;t.success&&(r=t.success),t.error&&(i=t.error),s[e+"SuccessCallback"]=r,s[e+"ErrorCallback"]=i},e.actionErrorCallback=function(e,t){return t[e+"ErrorCallback"]},e.actionSuccessCallback=function(e,t){return t[e+"SuccessCallback"]},e.getServerError=function(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",2002:"biz channel error",1000000000:"liveroom cmd error, result="};if(0===e)return{code:"ZegoClient.Success",msg:"success"};var s={code:"ZegoClient.Error.Server",msg:""};return s.msg=e>1e9?t[1e9]+e:t[e]?"unknown error code:"+e:t[e],s},e.isKeepTryLogin=function(e){switch(e){case 1002:case 1003:return!0;default:return!1}},e.mergeStreamList=function(e,t,s,r,i){e.debug("msl.0 call");for(var o,n=[],a=[],l=[],h=0;h<r.length;h++)if(r[h].anchor_id_name!=t){o=!1;for(var u=0;u<s.length;u++)if(r[h].stream_id===s[u].stream_id){r[h].extra_info!==s[u].extra_info&&l.push(r[h]),o=!0;break}o||n.push(r[h])}else e.debug("msl.0 have self stream added");for(var d=0;d<s.length;d++){o=!1;for(var c=0;c<r.length;c++)if(r[c].anchor_id_name!=t){if(s[d].stream_id===r[c].stream_id){o=!0;break}}else e.debug("msl.0 have self stream deleted");o||a.push(s[d])}s=r,i(n,a,l),e.debug("msl.0 call success")},e.checkCustomCommandParam=function(e){return!0},e.generateRandumNumber=function(e){return parseInt(Math.random()*(e+1)+"",10)},e.uuid=function(e,t){var s,r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=[];if(t=t||r.length,e)for(s=0;s<e;s++)i[s]=r[0|Math.random()*t];else{var o=void 0;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",s=0;s<36;s++)i[s]||(o=0|16*Math.random(),i[s]=r[19==s?3&o|8:o])}return i.join("")},e.isSupportWebrtc=function(){var e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,s=window.WebSocket;return!!e&&!!t&&!!s},e.isSupportH264=function(e,t){new RTCPeerConnection(null).createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(function(t){if(t&&t.sdp){var s=t.sdp.split("\r\n").some(function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("H264/")>-1});e(s)}},function(e){t(e)})},e}();t.ClientUtil=r},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.url=e,this.protocol=t||null,this.readyState=3,this._websocket=wx.connectSocket({url:e}),this.init()}return e.prototype.init=function(){var e=this;this._websocket&&(this.readyState=0,this._websocket.onOpen(function(t){e.readyState=e._websocket.readyState,"function"==typeof e.onopen&&(e.onopen(t),e._websocket.onClose(function(t){e.readyState=e._websocket.readyState,"function"==typeof e.onclose&&e.onclose(t)}),e._websocket.onMessage(function(t){"function"==typeof e.onmessage&&e.onmessage(t)}))}),this._websocket.onError(function(t){e.readyState=e._websocket.readyState,"function"==typeof e.onerror&&e.onerror(t)}))},e.prototype.onopen=function(e){},e.prototype.onerror=function(e){},e.prototype.onclose=function(e){},e.prototype.onmessage=function(e){},e.prototype.send=function(e){this._websocket&&this._websocket.send({data:e})},e.prototype.close=function(){this._websocket&&this._websocket.close()},e}();t.ZegoWebSocket=r},function(e,t,s){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.playErrorList={DISPATCH_ERROR:{code:"ZegoPlayWeb.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPlayWeb.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPlayWeb.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.RemoteOffer",msg:"wating server mediaDesc timeout"},SET_REMOTE_DESC_ERROR:{code:"ZegoPlayWeb.Error.RemoteOffer",msg:"other side offer error"},CREATE_ANSWER_ERROR:{code:"ZegoPlayWeb.Error.CreateAnswer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPlayWeb.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Desc",msg:"send mediaDesc timeout"},SEND_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.Candidate",msg:"send candidate error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Candidate",msg:"send candidate timeout"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.ServerCandidate",msg:"recv candidate error"},MEDIA_CONNECTION_FAILED:{code:"ZegoPlayWeb.Error.ConnectionFailed",msg:"ice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPlayWeb.Error.ConnectionClosed",msg:"ice connection state closed"},SESSION_CLOSED:{code:"ZegoPlayWeb.Error.SessionClosed",msg:"server session closed"},WEBSOCKET_ERROR:{code:"ZegoPlayWeb.Error.SocketError",msg:"network error"}},t.publishErrorList={DISPATCH_ERROR:{code:"ZegoPublish.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPublish.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPublish.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPublish.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPublish.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.Desc",msg:"send mediaDesc timeout"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.ServerAnswer",msg:"waiting server mediaDesc timeout"},SERVER_MEDIA_DESC_ERROR:{code:"ZegoPublish.Error.ServerAnswer",msg:"server mediaDesc type error"},SET_REMOTE_DESC_ERROR:{code:"ZegoPublish.Error.RemoteDesc",msg:"other side offer error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.Candidate",msg:"sendIceCandidate error"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPublish.Error.ServerCandidate",msg:"recv candidate error"},SESSION_CLOSED:{code:"ZegoPublish.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_FAILED:{code:"ZegoPublish.Error.IConnectionFailed",msg:"Iice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPublish.Error.ConnectionClosed",msg:"ice connection state closed"},WEBSOCKET_ERROR:{code:"ZegoPublish.Error.SocketError",msg:"network error"}},t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.getSeq=(r=1,function(){return r++})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(3),o=function(){function e(){this.testEnvironment=!1,this.third_token="",this.pullLimited=!0,this.configOK=!1,this.roomCreateFlag=1,this.runState=r.ENUM_RUN_STATE.logout,this.lastRunState=r.ENUM_RUN_STATE.logout,this.callbackList={},this.streamList=[],this.publishStreamList={},this.userQuerying=!1,this.userTempList=[],this.userSeq=0,this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.sendCommandMap={},this.sendCommandList=new r.LinkedList,this.sendDataMap={},this.sendDataList=new r.LinkedList,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.streamUrlMap={},this.cmdCallback={},this.transSeqMap={},this.realyMessageList=[],this.relayTimer=null,this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.bigImMessageList=[],this.tryLoginCount=0,this.tryLoginTimer=null,this.heartbeatTimer=null,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.cmdSeq=0}return e.prototype.isLogin=function(){return this.runState===r.ENUM_RUN_STATE.login},e.prototype.getRequestId=function(){return this.idName+"-"+i.getSeq()},e.prototype.getSignalCmdContent=function(e,t,s){var r={request_id:e,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:t};return void 0!=s&&(r.result=s),JSON.stringify(r)},e}();t.StateCenter=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=function(){function e(e,t,s){this.logger=e,this.socketCenter=s,this.stateCenter=t}return e.prototype.requestJoinLive=function(e,t,s,i){this.logger.debug("zb.lh.rjl call");var o=this.stateCenter.getRequestId(),n=this.stateCenter.getSignalCmdContent(o,e);return void 0!=i&&(this.stateCenter.joinLiveCallbackMap[o]=i,this.sendSignalCmd(r.ENUM_SIGNAL_SUB_CMD.joinLiveRequest,n,e,t,s),!0)},e.prototype.inviteJoinLive=function(e,t,s,i){this.logger.debug("zb.lh.ijl call");var o=this.stateCenter.getRequestId(),n=this.stateCenter.getSignalCmdContent(o,e);return void 0!=i&&(this.stateCenter.joinLiveCallbackMap[o]=i,this.sendSignalCmd(r.ENUM_SIGNAL_SUB_CMD.joinLiveInvite,n,e,t,s),!0)},e.prototype.endJoinLive=function(e,t,s){this.logger.debug("zb.lh.ejl call");var i=this.stateCenter.getRequestId(),o=this.stateCenter.getSignalCmdContent(i,e);return this.sendSignalCmd(r.ENUM_SIGNAL_SUB_CMD.joinLiveStop,o,e,t,s),!0},e.prototype.respondJoinLive=function(e,t,s,i){this.logger.debug("zb.lh.rpjl call");var o=this.stateCenter.joinLiveRequestMap[e];if(!o)return this.logger.info("zb.lh.rpjl no dest id name"),!1;var n=0;!0===t&&(n=1);var a=this.stateCenter.getSignalCmdContent(e,o,n);return this.sendSignalCmd(r.ENUM_SIGNAL_SUB_CMD.joinLiveResult,a,o,s,i),delete this.stateCenter.joinLiveRequestMap[e],!0},e.prototype.sendSignalCmd=function(e,t,s,r,i){if(this.logger.debug("zb.lh.ssc call"),this.stateCenter.isLogin()){this.logger.debug("zb.lh.ssc send signal cmd "+e);var o={sub_cmd:e,signal_msg:t,dest_id_name:[s]};this.socketCenter.sendMessage("signal",o,r,i),this.logger.info("zb.lh.ssc call success")}else this.logger.error("zb.lh.ssc state error")},e.prototype.handlePushSignalMsg=function(e){if(this.stateCenter.isLogin()){var t=JSON.parse(e.body.signal_msg);switch(this.logger.debug("zb.lh.hpcm hpsm= ",t),e.body.sub_cmd){case r.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:this.handlePushJoinLiveRequestMsg(t);break;case r.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:this.handlePushJoinLiveResultMsg(t);break;case r.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:this.handlePushJoinLiveInviteMsg(t);break;case r.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:this.handlePushJoinLiveStopMsg(t)}this.logger.debug("zb.lh.hpsm call end")}else this.logger.warn("zb.lh.hpsm not login")},e.prototype.handlePushJoinLiveRequestMsg=function(e){var t=e.request_id;if("string"==typeof t){var s=e.from_userid;"string"==typeof s?(this.stateCenter.joinLiveRequestMap[t]=s,this.logger.info("zb.lh.hpjlrm onRecvJoinLiveRequest "+s),this.onRecvJoinLiveRequest(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlrm no from user")}else this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.onRecvJoinLiveRequest=function(e,t,s,r){},e.prototype.handlePushJoinLiveInviteMsg=function(e){var t=e.request_id;if("string"==typeof t){var s=e.from_userid;"string"==typeof s?(this.stateCenter.joinLiveRequestMap[t]=s,this.logger.info("zb.lh.hpjlim onRecvInviteJoinLiveRequest "+s),this.onRecvInviteJoinLiveRequest(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlim no from user")}else this.logger.error("zb.lh.hpjlim no requestId")},e.prototype.onRecvInviteJoinLiveRequest=function(e,t,s,r){},e.prototype.handlePushJoinLiveResultMsg=function(e){var t=e.request_id;if("string"==typeof t){var s=e.result;if(void 0!=s){var r=1==s;if(this.stateCenter.joinLiveCallbackMap[t]){var i=this.stateCenter.joinLiveCallbackMap[t];if(!i)return void this.logger.info("hpjlrm.o no callback");this.logger.info("zb.lh.hpjlrm joinLiveRequest/invite result "+r),delete this.stateCenter.joinLiveCallbackMap[t],i(r,e.from_userid,e.from_username)}}else this.logger.info("zb.lh.hpjlrm no result")}else this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.handlePushJoinLiveStopMsg=function(e){var t=e.request_id;"string"==typeof t?(this.logger.info("zb.lh.hpjlsm onRecvEndJoinLiveCommand "+e.from_userid),this.onRecvEndJoinLiveCommand(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlsm no requestId")},e.prototype.onRecvEndJoinLiveCommand=function(e,t,s,r){},e}();t.LiveHandler=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(1),o=function(){function e(e,t,s){this.logger=e,this.socketCenter=s,this.stateCenter=t}return e.prototype.sendCustomCommand=function(e,t,s,r){var o=this;if(this.logger.debug("zb.mh.scc call"),!this.stateCenter.isLogin())return this.logger.error("zb.mh.scc state error"),!1;if(!e||0==e.length)return this.logger.error("zb.mh.scc dstMembers error"),!1;var n={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:t||"",room_id:this.stateCenter.roomid},a={dest_id_name:e,custom_msg:JSON.stringify(n)};return i.ClientUtil.checkCustomCommandParam(a)?(this.socketCenter.registerRouter("custommsg",function(e){o.handleSendCustomMsgRsp(e)}),this.socketCenter.sendCustomMessage("custommsg",a,s,r),this.logger.info("zb.mh.scc call success"),!0):(this.logger.info("zb.mh.scc param error"),!1)},e.prototype.handleSendCustomMsgRsp=function(e){this.logger.debug("zb.mh.hscmrcall");var t,s=this.stateCenter.sendDataMap[e.header.seq];null!=s?("custommsg"!=(t=s._data).data.header.cmd?this.logger.error("zb.mh.hscmrcmd wrong"+t.data.header.cmd):0===e.body.err_code?null!=t.success&&t.success(e.header.seq,t.data.body.custom_msg):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.custom_msg),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(s)):this.logger.error("zb.mh.hscmrno found seq="+e.header.seq),this.logger.debug("zb.mh.hscmr  call success")},e.prototype.handlePushCustomMsg=function(e){var t=JSON.parse(e.body.custommsg);this.logger.debug("zb.mh.hpcm submsg=",t),this.onRecvCustomCommand(t.from_userid,t.from_username,t.custom_content)},e.prototype.onRecvCustomCommand=function(e,t,s){},e.prototype.sendRoomMsg=function(e,t,s,i,o){var n=this;if(this.logger.debug("zb.mh.srm call"),this.stateCenter.isLogin()){var a=Date.parse(new Date+"");if(this.stateCenter.sendRoomMsgTime>0&&this.stateCenter.sendRoomMsgTime+this.stateCenter.SendRoomMsgInterval>a)return this.logger.info("zb.mh.srm freq error"),void(o&&o(r.sdkErrorList.FREQ_LIMITED,0,e,t,s));this.stateCenter.sendRoomMsgTime=a,this.logger.debug("zb.mh.srm send fetch request");var l={msg_category:e,msg_type:t,msg_content:s};this.socketCenter.registerRouter("im_chat",function(e){n.handleSendRoomMsgRsp(e)}),this.socketCenter.sendCustomMessage("im_chat",l,i,o),this.logger.info("zb.mh.srm call success")}else this.logger.error("zb.mh.srm state error")},e.prototype.handleSendRoomMsgRsp=function(e){this.logger.debug("zb.mh.hsrmr call");var t,s=this.stateCenter.sendDataMap[e.header.seq];null!=s?("im_chat"!=(t=s._data).data.header.cmd?this.logger.error("zb.mh.hsrmr cmd wrong"+t.data.header.cmd):0===e.body.err_code?t.success&&t.success(e.header.seq,e.body.msg_id,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content):t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(s)):this.logger.error("hzb.mh.hsrmr no found seq="+e.header.seq),this.logger.info("zb.mh.hsrmr call success")},e.prototype.onRecvRoomMsg=function(e,t,s){},e.prototype.sendReliableMessage=function(e,t,s,r){this.logger.debug("zb.mh.srirm call"),this.stateCenter.transSeqMap[e]&&delete this.stateCenter.transSeqMap[e],this.stateCenter.transSeqMap[e]={seq:0};var i={trans_type:e,trans_data:t};this.socketCenter.sendMessage("trans",i,s,r)},e.prototype.sendBigRoomMessage=function(e,t,s,r,i){var o=this;this.logger.debug("zb.mh.sbim call");var n=this.stateCenter.bigimTimeWindow,a=this.stateCenter.serverTimeOffset,l=(new Date).getTime()+a,h=(++this.stateCenter.cmdSeq).toString();if(void 0==r&&(r=null),void 0==i&&(i=null),this.stateCenter.bigImCallbackMap[h]={success:r,error:i},0==n){var u={msg_category:e,msg_type:t,msg_content:s,bigmsg_client_id:h};this.logger.debug("zb.mh.sbim no time window"),this.sendBigRoomMessageInternal([u],function(e){o.handleBigImMsgRsp(e)},i)}else{var d=Math.floor(l/n);if(this.logger.debug("currentIndex "+d+" lastTimeIndex "+this.stateCenter.bigImLastTimeIndex),this.stateCenter.bigImLastTimeIndex<d&&0==this.stateCenter.bigImMessageList.length){this.stateCenter.bigImLastTimeIndex=d;var c={msg_category:e,msg_type:t,msg_content:s,bigmsg_client_id:h};this.sendBigRoomMessageInternal([c],function(e){o.handleBigImMsgRsp(e)},i)}else this.stateCenter.bigImMessageList.push({msg_category:e,msg_type:t,msg_content:s,bigmsg_client_id:h}),1==this.stateCenter.bigImMessageList.length&&this.setBigImTimer(a,n)}},e.prototype.handlePushMergeMsg=function(e){if(this.stateCenter.isLogin()){for(var t=0;t<e.body.messages.length;t++)14001===e.body.messages[t].sub_cmd&&this.handlePushBigRooMsg(e.body.messages[t].msg_body);this.logger.debug("zb.mh.hpmm call success")}else this.logger.error("zb.mh.hpmmnot login")},e.prototype.handlePushBigRooMsg=function(e){var t;try{t=JSON.parse(e)}catch(e){return void this.logger.warn("zb.mh.hpbrm parse json error")}if(t){for(var s=t.room_id,r=[],i=0;i<t.msg_data.length;i++){var o=t.msg_data[i];o.id_name!=this.stateCenter.idName?r.push({idName:o.id_name,nickName:o.nick_name,messageId:o.bigmsg_id,category:o.msg_category,type:o.msg_type,content:o.msg_content,time:o.send_time}):this.logger.debug("zb.mh.hpbrm self message")}0==r.length?this.logger.debug("zb.mh.hpbrm no other pushData except self"):this.onRecvBigRoomMessage(r,s),this.logger.debug("zb.mh.hpbrm call success")}else this.logger.warn("zb.mh.hpbrm cann't find message body")},e.prototype.onRecvBigRoomMessage=function(e,t){},e.prototype.sendBigRoomMessageInternal=function(e,t,s){this.logger.debug("zb.mh.sbim call");var r={msgs:e};this.socketCenter.sendMessage("bigim_chat",r,t,s)},e.prototype.handleBigImMsgRsp=function(e){if(this.stateCenter.isLogin()){this.stateCenter.bigimTimeWindow!=e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window);for(var t=0;t<e.body.msgs.length;t++){var s=e.body.msgs[t].bigmsg_client_id,r=e.body.msgs[t].bigmsg_id;if(this.stateCenter.bigImCallbackMap[s]){var i=this.stateCenter.bigImCallbackMap[s].success;null!=i&&i(e.header.seq,r),delete this.stateCenter.bigImCallbackMap[s]}}}else this.logger.info("zb.mh.hbmr not login")},e.prototype.setBigImTimer=function(e,t){var s=this,r=t-((new Date).getTime()+e)%t,o=i.ClientUtil.generateRandumNumber(t)+r;this.logger.info("zb.mh.sbt setTimer "+o),this.stateCenter.bigImTimer=setTimeout(function(){s.onBigImTimer()},o)},e.prototype.onBigImTimer=function(){var e=this,t=(new Date).getTime()+this.stateCenter.serverTimeOffset;this.stateCenter.bigImLastTimeIndex=Math.floor(t/this.stateCenter.bigimTimeWindow);for(var s=[],r=[],i=0;i<this.stateCenter.bigImMessageList.length&&!(i>=20);i++){var o=this.stateCenter.bigImMessageList[i];s.push({msg_category:o.msg_category,msg_type:o.msg_type,msg_content:o.msg_content,bigmsg_client_id:o.bigmsg_client_id}),r.push(o.bigmsg_client_id)}this.stateCenter.bigImMessageList.length>20?this.stateCenter.bigImMessageList.splice(0,20):this.stateCenter.bigImMessageList=[],this.sendBigRoomMessageInternal(s,function(t){e.handleBigImMsgRsp(t)},function(t,s){for(var i=0;i<r.length;i++){var o=r[i],n=e.stateCenter.bigImCallbackMap[o];n&&(null!=n.error&&n.error(t,s),delete e.stateCenter.bigImCallbackMap[o])}}),clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null,this.stateCenter.bigImMessageList.length>0&&this.setBigImTimer(this.stateCenter.serverTimeOffset,this.stateCenter.bigimTimeWindow)},e.prototype.sendRelayMessage=function(e,t,s,r){this.logger.debug("zb.mh.srm call");var i=this.stateCenter.datiTimeWindow,o=this.stateCenter.serverTimeOffset;i>0?(this.stateCenter.realyMessageList.push({type:e,data:t,success:s,error:r}),1==this.stateCenter.realyMessageList.length&&this.setRelayTimer(o,i)):this.sendRelayMessageInternal(e,t,s,r)},e.prototype.sendRelayMessageInternal=function(e,t,s,r){this.logger.debug("zb.mh.srmi call");var i={relay_type:e,relay_data:t};this.socketCenter.sendMessage("relay",i,s,r)},e.prototype.setRelayTimer=function(e,t){var s=this,r=2*t-((new Date).getTime()+e)%t,o=i.ClientUtil.generateRandumNumber(r);this.logger.info("zb.mh.srt setTimer "+o),this.stateCenter.relayTimer=setTimeout(function(){s.onRelayTimer()},o)},e.prototype.onRelayTimer=function(){if(0!=this.stateCenter.realyMessageList.length){var e=this.stateCenter.realyMessageList[0];this.sendRelayMessageInternal(e.type,e.data,e.success,e.error),clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null,this.stateCenter.realyMessageList.splice(0,1),this.stateCenter.realyMessageList.length>0&&this.setRelayTimer(this.stateCenter.serverTimeOffset,this.stateCenter.datiTimeWindow)}else this.logger.info("zb.mh.ort no relay data")},e.prototype.handlePushTransMsg=function(e){if(this.stateCenter.isLogin()){var t=e.body.trans_type,s=e.body.trans_seq;this.stateCenter.transSeqMap[t]?this.stateCenter.transSeqMap[t].seq=s:this.stateCenter.transSeqMap[t]={seq:s},e.body.trans_user_idname!=this.stateCenter.idName?this.onRecvReliableMessage(t,s,e.body.trans_data):this.logger.debug("zb.mh.hptr receive self trans message"),this.logger.info("zb.mh.hptr trans "+t+" seq "+s)}else this.logger.error("zb.mh.hptr not login")},e.prototype.onRecvReliableMessage=function(e,t,s){},e}();t.MessageHandler=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(1),o=function(){function e(e,t,s){this.logger=e,this.socketCenter=s,this.stateCenter=t}return e.prototype.resetHeartbeat=function(){this.logger.debug("zb.hb.rht call"),clearTimeout(this.stateCenter.heartbeatTimer),this.stateCenter.heartbeatTimer=null,this.stateCenter.tryHeartbeatCount=0,this.logger.debug("zb.hb.rht call success")},e.prototype.hbLogout=function(e){},e.prototype.start=function(e){var t=this;if(this.logger.debug("zb.hb.sht call"),this.stateCenter.isLogin()){if(++this.stateCenter.tryHeartbeatCount>3)return this.logger.error("zb.hb.sht come to try limit"),void this.hbLogout(r.sdkErrorList.HEARTBEAT_TIMEOUT);this.logger.debug("zb.hb.sht send packet");this.socketCenter.registerRouter("hb",function(e){t.handleHeartbeatRsp(e)}),this.socketCenter.sendMessage("hb",{reserve:0}),this.logger.debug("zb.hb.sht call success"),this.stateCenter.heartbeatInterval=e,this.stateCenter.heartbeatTimer=setTimeout(function(){t.start(t.stateCenter.heartbeatInterval)},this.stateCenter.heartbeatInterval)}else this.logger.error("zb.hb.sht state error")},e.prototype.handleHeartbeatRsp=function(e){if(this.logger.debug("zb.hb.hhbr call"),0!==e.body.err_code)return this.logger.error("zb.hb.hhbr call disconnect, server error=",e.body.err_code),void this.hbLogout(i.ClientUtil.getServerError(e.body.err_code));for(var t in this.stateCenter.tryHeartbeatCount=0,this.stateCenter.heartbeatInterval=e.body.hearbeat_interval,this.stateCenter.heartbeatInterval<r.MINIUM_HEARTBEAT_INTERVAL&&(this.stateCenter.heartbeatInterval=r.MINIUM_HEARTBEAT_INTERVAL),e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),this.ReliableMessageHandler(e),this.fetchStreamList(e),e.body.server_user_seq!==this.stateCenter.userSeq&&this.stateCenter.userStateUpdate&&(this.logger.info("zb.hb.hhbr call update user "+e.body.server_user_seq,this.stateCenter.userSeq),this.fetchUserList()),this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[t].state==r.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.logger.info("zb.hb.hhbr try to update stream info"),this.updateStreamInfo(t,r.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info));void 0!=e.body.online_count&&0!=e.body.online_count&&this.onUpdateOnlineCount(this.stateCenter.roomid,e.body.online_count),this.logger.debug("zb.hb.hhbr call success")},e.prototype.ReliableMessageHandler=function(e){if(e.body.trans_seqs)for(var t=0;t<e.body.trans_seqs.length;t++){var s=e.body.trans_seqs[t].trans_type,r=e.body.trans_seqs[t].trans_seq;if(!this.stateCenter.transSeqMap[s]||this.stateCenter.transSeqMap[s].seq!==r){var i=0;this.stateCenter.transSeqMap[s]?(i=this.stateCenter.transSeqMap[s].seq,this.logger.debug("zb.hb.rmh type "+s+" old seq "+this.stateCenter.transSeqMap[s].seq+" server seq "+r)):(i=0,this.logger.debug("zb.hb.rmh type "+s+" server seq "+r)),this.fetchReliableMessage(s,i)}}},e.prototype.fetchReliableMessage=function(e,t){var s=this;this.logger.debug("zb.hb.frm call");var r={trans_type:e,trans_local_seq:t};this.socketCenter.registerRouter("trans_fetch",function(e){s.handleFetchTransRsp(e)}),this.socketCenter.sendMessage("trans_fetch",r),this.logger.debug("zb.hb.frm call success")},e.prototype.handleFetchTransRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){var t=e.body.trans_type,s=e.body.trans_seq;this.stateCenter.transSeqMap[t]={seq:s},e.body.trans_user_idname!=this.stateCenter.idName&&this.onRecvReliableMessage(t,s,e.body.trans_data),this.logger.debug("zb.hb.hftr trans "+t+" seq "+s)}else this.logger.error("zb.hb.hftr trans send error "+e.body.err_code);else this.logger.error("zb.hb.hftr not login")},e.prototype.fetchStreamList=function(e){var t=this;e.body.stream_seq!==this.stateCenter.streamSeq&&(this.logger.debug("zb.hb.fsl current seq "+this.stateCenter.streamSeq+" server Seq "+e.body.stream_seq),this.logger.debug("zb.hb.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.warn("zb.hb.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.hb.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",function(e){t.handleFetchStreamListRsp(e)}),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.hb.fsl call success")):this.logger.error("zb.hb.fsl state error"))},e.prototype.handleFetchStreamListRsp=function(e){},e.prototype.fetchUserList=function(){},e.prototype.updateStreamInfo=function(e,t,s,r){void 0===s&&(s="")},e.prototype.onUpdateOnlineCount=function(e,t){},e.prototype.onRecvReliableMessage=function(e,t,s){},e.prototype.resetCheckMessage=function(){this.logger.debug("zb.hb.rcm call"),clearTimeout(this.stateCenter.sendDataCheckTimer),this.stateCenter.sendDataCheckTimer=null,this.checkSendMessageList(this.stateCenter.sendDataList),this.checkSendMessageList(this.stateCenter.sendCommandList),this.stateCenter.sendDataMap={},this.stateCenter.sendCommandMap={},this.logger.debug("zb.hb.rcm call success")},e.prototype.checkSendMessageList=function(e){for(var t=e.getFirst();null!=t;)e.remove(t),t._data.error&&(t._data.data.body.custom_msg?t._data.error(r.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq,t._data.data.body.custom_msg):t._data.error(r.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq)),t=e.getFirst()},e.prototype.checkMessageListTimeout=function(e,t){for(var s=e.getFirst(),i=Date.parse(new Date+""),o=0,n=0,a=0;!(null==s||s._data.time+this.stateCenter.sendDataTimeout>i||(delete t[s._data.data.header.seq],e.remove(s),++n,null==s._data.error||this.stateCenter.sendDataDropTimeout>0&&s._data.time+this.stateCenter.sendDataDropTimeout<i?++a:s._data.data.body.custom_msg?s._data.error(r.sdkErrorList.SEND_MSG_TIMEOUT,s._data.data.header.seq,s._data.data.body.custom_msg):s._data.error(r.sdkErrorList.SEND_MSG_TIMEOUT,s._data.data.header.seq),++o>=this.stateCenter.sendDataCheckOnceCount));)s=e.getFirst();0==n&&0==a||this.logger.debug("zb.hb.cmt call success, stat: timeout=",n,"drop=",a)},e.prototype.startCheckMessageTimeout=function(){var e=this;this.stateCenter.isLogin()?(this.checkMessageListTimeout(this.stateCenter.sendDataList,this.stateCenter.sendDataMap),this.checkMessageListTimeout(this.stateCenter.sendCommandList,this.stateCenter.sendCommandMap),this.stateCenter.sendDataCheckTimer=setTimeout(function(){e.startCheckMessageTimeout()},this.stateCenter.sendDataCheckInterval)):this.logger.error("zb.hb.scmt state error")},e}();t.HeartBeatHandler=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(1),o=function(){function e(e,t,s){this.logger=e,this.socketCenter=s,this.stateCenter=t}return e.prototype.setCDNInfo=function(e,t){},e.prototype.onStreamUpdated=function(e,t){},e.prototype.onStreamExtraInfoUpdated=function(e){},e.prototype.handleStreamStart=function(e,t){var s=this;if(this.stateCenter.streamQuerying=!1,this.socketCenter.registerRouter("stream",function(e){s.handleStreamUpdateRsp(e)}),this.socketCenter.registerRouter("push_stream_update",function(e){s.handlePushStreamUpdateMsg(e)}),e==r.ENUM_RUN_STATE.login)this.logger.info("zb.sh.hss recover from disconnect so call streamupdate"),this.handleFullUpdateStream(t.body.stream_seq,t.body.stream_info||[]);else{this.logger.info("zb.sh.hss success callback user"),this.stateCenter.streamList=t.body.stream_info||[],this.stateCenter.streamSeq=t.body.stream_seq;for(var o=0;o<this.stateCenter.streamList.length;o++)this.stateCenter.streamList[o].anchor_id_name==this.stateCenter.idName&&(this.updateStreamInfo(this.stateCenter.streamList[o].stream_id,r.ENUM_STREAM_SUB_CMD.liveEnd),this.stateCenter.streamList.splice(o,1));var n=this.makeCallbackStreamList(this.stateCenter.streamList);i.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(n)}},e.prototype.onPublishStateUpdate=function(e,t,s){},e.prototype.updateStreamInfo=function(e,t,s,r){var i=this;void 0===s&&(s=""),this.logger.debug("zb.sh.usi call");var o={stream_id:e,extra_info:s},n={sub_cmd:t,stream_msg:JSON.stringify(o)};this.socketCenter.registerRouter("stream",function(e){i.handleStreamUpdateRsp(e)}),this.socketCenter.sendMessage("stream",n,void 0,r),this.logger.info("zb.sh.usi call success cmd "+t)},e.prototype.handleStreamUpdateRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+e.body.stream_seq),this.stateCenter.streamSeq=e.body.stream_seq;for(var t=0;t<e.body.stream_info.length;t++){var s=e.body.stream_info[t].stream_id;if(!this.stateCenter.publishStreamList[s])return void this.logger.info("hsur.0 stream is not exist");this.stateCenter.publishStreamList[s].state==r.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.stateCenter.publishStreamList[s].state=r.ENUM_PUBLISH_STREAM_STATE.publishing,this.onPublishStateUpdate(0,s,0))}}else this.logger.error("zb.sh.hsur stream update error "+e.body.err_code);else this.logger.error("zb.sh.hsur not login")},e.prototype.handleFetchStreamListRsp=function(e){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===e.body.err_code?this.stateCenter.streamSeq!==e.body.stream_seq?(this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info),this.logger.debug("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",e.body.err_code)},e.prototype.handleFullUpdateStream=function(e,t){var s=this;this.logger.debug("zb.sh.hfus call"),this.stateCenter.streamSeq=e,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),i.ClientUtil.mergeStreamList(this.logger,this.stateCenter.idName,this.stateCenter.streamList,t,function(e,t,i){0!==e.length&&(s.logger.debug("zb.sh.hfus callback addstream"),s.onStreamUpdated(r.ENUM_STREAM_UPDATE_TYPE.added,s.makeCallbackStreamList(e))),0!==t.length&&(s.logger.debug("zb.sh.hfus callback delstream"),s.onStreamUpdated(r.ENUM_STREAM_UPDATE_TYPE.deleted,s.makeCallbackStreamList(t))),0!==i.length&&(s.logger.debug("zb.sh.hfus callback updatestream"),s.onStreamExtraInfoUpdated(s.makeCallbackStreamList(i)))}),this.logger.info("zb.sh.hfus call success")},e.prototype.handlePushStreamUpdateMsg=function(e){if(this.logger.info("zb.sh.hpsum call"),e.body.stream_info&&0!==e.body.stream_info.length){if(e.body.stream_info.length+this.stateCenter.streamSeq!==e.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=e.body.stream_seq,e.body.stream_cmd){case r.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(e.body.stream_info);break;case r.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(e.body.stream_info);break;case r.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(e.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},e.prototype.handleAddedStreamList=function(e){this.logger.debug("zb.sh.hasl call");for(var t,s=[],i=0;i<e.length;i++)if(e[i].anchor_id_name!=this.stateCenter.idName){t=!1;for(var o=0;o<this.stateCenter.streamList.length;o++)if(e[i].stream_id===this.stateCenter.streamList[o].stream_id){t=!0;break}t||s.push(e[i])}else this.logger.debug("hdsl.0 have self stream added");if(0!==s.length){this.logger.debug("zb.sh.hasl callback addstream");for(var n=0;n<s.length;n++)this.stateCenter.streamList.push(s[n]);this.onStreamUpdated(r.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(s))}this.logger.info("zb.sh.hasl call success")},e.prototype.handleDeletedStreamList=function(e){this.logger.debug("zb.sh.hdsl call");for(var t=[],s=0;s<e.length;s++)if(e[s].anchor_id_name!=this.stateCenter.idName){for(var i=this.stateCenter.streamList.length-1;i>=0;i--)if(e[s].stream_id===this.stateCenter.streamList[i].stream_id){this.stateCenter.streamList.splice(i,1),t.push(e[s]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==t.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(r.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(t))),this.logger.info("zb.sh.hdsl call")},e.prototype.handleUpdatedStreamList=function(e){this.logger.debug("zb.sh.husl call");for(var t=[],s=0;s<e.length;s++)if(e[s].anchor_id_name!=this.stateCenter.idName){for(var r=0;r<this.stateCenter.streamList.length;r++)if(e[s].stream_id===this.stateCenter.streamList[r].stream_id){e[s].extra_info!==this.stateCenter.streamList[r].extra_info&&(this.stateCenter.streamList[r]=e[s],t.push(e[s]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==t.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.makeCallbackStreamList(t))),this.logger.info("zb.sh.husl call success")},e.prototype.fetchStreamList=function(){if(this.logger.info("zb.sh.fsl call"),this.stateCenter.isLogin())this.logger.info("zb.sh.fsl state error");else if(this.stateCenter.streamQuerying)this.logger.info("zb.sh.fsl already doing");else{this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request");this.socketCenter.registerRouter("stream_info",this.handleFetchStreamListRsp),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.sh.fsl call success")}},e.prototype.makeCallbackStreamList=function(e){var t=[];if(e&&e.length>0)for(var s=0;s<e.length;s++){var r={anchor_id_name:e[s].anchor_id_name,stream_gid:e[s].stream_gid,anchor_nick_name:e[s].anchor_nick_name,extra_info:e[s].extra_info,stream_id:e[s].stream_id,urls_flv:"",urls_rtmp:"",urls_hls:"",urls_https_flv:"",urls_https_hls:""};this.setCDNInfo(r,e[s]),t.push(r)}return t},e.prototype.updateMixStream=function(e,t,s){var o=this;if(this.logger.info("zb.sh.ums call"),void 0==e.outputStreamId&&void 0==e.outputUrl)return this.logger.error("zb.sh.ums no mix stream info"),!1;if(0==e.streamList.length)return this.logger.error("zb.sh.ums no input stream"),!1;var n={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:r.PROTO_VERSION};"string"==typeof e.userData&&e.userData.length<=1e4&&(n.UserData=e.userData);for(var a=[],l=0;l<e.streamList.length;l++){var h=e.streamList[l],u=h.streamId;this.stateCenter.testEnvironment&&(u="zegotest-"+this.stateCenter.appid+"-"+h.streamId),a.push({stream_id:u,rect:{layer:l,top:h.top,left:h.left,bottom:h.bottom,right:h.right}})}n.MixInput=a;var d={};if(void 0!=e.outputStreamId?this.stateCenter.testEnvironment?d.stream_id="zegotest-"+this.stateCenter.appid+"-"+e.outputStreamId:d.stream_id=e.outputStreamId:void 0!=e.outputUrl&&(d.mixurl=e.outputUrl),!e.outputBitrate)return this.logger.error("zb.sh.ums no bitrate param"),!1;if(d.bitrate=e.outputBitrate,!e.outputFps)return this.logger.error("zb.sh.ums no fps param"),!1;if(d.fps=e.outputFps,!e.outputWidth)return this.logger.error("zb.sh.ums no width param"),!1;if(d.width=e.outputWidth,!e.outputHeight)return this.logger.error("zb.sh.ums no height param"),!1;d.height=e.outputHeight,e.outputAudioConfig&&(d.audio_enc_id=e.outputAudioConfig),e.outputAudioBitrate&&(d.audio_bitrate=e.outputAudioBitrate),e.outputAudioChannels&&(d.audio_channel_cnt=e.outputAudioChannels),e.outputBgColor&&(d.output_bg_color=e.outputBgColor),e.outputBgImage&&(d.output_bg_image=e.outputBgImage),this.stateCenter.testEnvironment?d.testenv=1:d.testenv=0,n.MixOutput=[d];var c={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(n)};return this.logger.debug("zb.sh.ums send command"),this.socketCenter.sendMessage("biz_channel",c,function(n,a,l){o.logger.debug("zb.sh.ums receive message");var h="zegotest-"+o.stateCenter.appid+"-";if(0!=l.length){for(var u=JSON.parse(l),d=[],c=e.outputStreamId,g=0;g<u.play.length;g++){var p={rtmpUrls:null,hlsUrls:null,flvUrls:null};o.stateCenter.testEnvironment&&c.startsWith(h)&&(c=c.slice(h.length)),u.play[g].rtmp_url&&u.play[g].rtmp_url.length>0&&(p.rtmpUrls=[u.play[g].rtmp_url]),u.play[g].hls_url&&u.play[g].hls_url.length>0&&(p.hlsUrls=[u.play[g].hls_url]),u.play[g].hdl_url&&u.play[g].hdl_url.length>0&&(p.flvUrls=[u.play[g].hdl_url]),d.push(p)}t&&t(c,d)}else s&&s(i.ClientUtil.getServerError(r.MIXSTREAM_ERROR_CODE+1))},function(e,t,n){if("number"==typeof e){o.logger.debug("zb.sh.ums error: "+e);var a=[];if(1000000150==e&&0!=n.length)for(var l=JSON.parse(n),h="zegotest-"+o.stateCenter.appid+"-",u=0;u<l.non_exist_streams.length;u++){var d=l.non_exist_streams[u];o.stateCenter.testEnvironment&&d.startsWith(h)?a.push(d.slice(h.length)):a.push(d)}s&&s(i.ClientUtil.getServerError(r.MIXSTREAM_ERROR_CODE+e),a)}else o.logger.debug("zb.sh.ums error code "+e.code),s&&s(e)}),!0},e.prototype.stopMixStream=function(e,t,s){if(this.logger.info("zb.sh.sms call"),void 0==e.outputStreamId&&void 0==e.outputUrl)return this.logger.error("zb.sh.sms no mix stream info"),!1;var o={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:r.PROTO_VERSION};void 0!=e.outputStreamId?this.stateCenter.testEnvironment?o.stream_id="zegotest-"+this.stateCenter.appid+"-"+e.outputStreamId:o.stream_id=e.outputStreamId:void 0!=e.outputUrl&&(o.mixurl=e.outputUrl);var n={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(o)};return this.socketCenter.sendMessage("biz_channel",n,function(e,s){t&&t()},function(e,t){"number"==typeof e?s&&s(i.ClientUtil.getServerError(r.MIXSTREAM_ERROR_CODE+e)):s&&s(e)}),!0},e.prototype.updateStreamExtraInfo=function(e,t){return this.logger.info("zb.sh.usei call"),e?"string"==typeof t&&(this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].extra_info=t,this.stateCenter.publishStreamList[e].state>=r.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(e,r.ENUM_STREAM_SUB_CMD.liveUpdate,t)),!0):(this.logger.error("zb.sh.usei param error"),!1)},e}();t.StreamHandler=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(1),o=function(){function e(e,t,s){this.logger=e,this.socketCenter=s,this.stateCenter=t}return e.prototype.setRunState=function(e){this.logger.debug("zb.rh.srs old="+this.stateCenter.runState+", new="+e),this.stateCenter.lastRunState=this.stateCenter.runState,this.stateCenter.runState=e},e.prototype.resetTryLogin=function(){this.logger.debug("zb.rh.rtl call"),clearTimeout(this.stateCenter.tryLoginTimer),this.stateCenter.tryLoginTimer=null,this.stateCenter.tryLoginCount=0,this.logger.debug("zb.rh.rtl call success")},e.prototype.resetBigRoomInfo=function(){this.stateCenter.transSeqMap={},this.stateCenter.realyMessageList=[],this.stateCenter.relayTimer&&(clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null),this.stateCenter.bigImLastTimeIndex=0,this.stateCenter.bigIMmessageList=[],this.stateCenter.bigImCallbackMap={},this.stateCenter.bigImTimer&&(clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null),this.stateCenter.serverTimeOffset=0,this.stateCenter.datiTimeWindow=0,this.stateCenter.bigimTimeWindow=0},e.prototype.resetRoom=function(){var e=this;if(this.logger.debug("zb.rh.rr call"),this.resetTryLogin(),this.resetRoomCallBack(),this.stateCenter.streamList=[],this.stateCenter.streamQuerying=!1,this.stateCenter.publishStreamList={},this.stateCenter.joinLiveCallbackMap={},this.stateCenter.joinLiveRequestMap={},this.stateCenter.streamUrlMap={},this.resetBigRoomInfo(),this.stateCenter.cmdCallback={},this.logger.debug("zb.rh.rr call send logout=",this.stateCenter.sessionid),"0"!==this.stateCenter.sessionid){this.socketCenter.registerRouter("logout",function(t){e.handleLogoutRsp(t)}),this.socketCenter.sendMessage("logout",{reserve:0})}this.socketCenter.closeSocket(),setTimeout(function(){e.setRunState(r.ENUM_RUN_STATE.logout),e.stateCenter.userid="",e.stateCenter.sessionid="",e.logger.setSessionInfo(e.stateCenter.appid,e.stateCenter.roomid,e.stateCenter.userid,e.stateCenter.idName,e.stateCenter.sessionid,r.PROTO_VERSION)},500),this.logger.debug("zb.rh.rr call success")},e.prototype.resetRoomCallBack=function(){},e.prototype.onDisconnect=function(e){},e.prototype.loginSuccessCallBack=function(e,t){},e.prototype.onGetTotalUserList=function(e,t){},e.prototype.login=function(e,t,s,o,n,a){if(this.logger.setSessionInfo(this.stateCenter.appid,e,"",this.stateCenter.idName,"",r.PROTO_VERSION),this.logger.info("zb.rh.lg call:",e,s),o&&(this.stateCenter.third_token=o),!this.stateCenter.configOK||!i.ClientUtil.checkLoginParam(e,s))return this.logger.error("zb.rh.lg param error"),void a({code:"",msg:"param error"});this.stateCenter.runState!==r.ENUM_RUN_STATE.logout&&(this.logger.debug("zb.rh.lg reset"),this.setRunState(r.ENUM_RUN_STATE.logout),this.resetRoom()),this.logger.debug("zb.rh.lg begin"),this.setRunState(r.ENUM_RUN_STATE.trylogin),this.stateCenter.roomid=e,this.stateCenter.token=s,this.stateCenter.role=t,i.ClientUtil.registerCallback("login",{success:n,error:a},this.stateCenter.callbackList),this.resetTryLogin(),this.tryLogin(),this.logger.info("zb.rh.lg call success")},e.prototype.loginBodyData=function(){return null},e.prototype.tryLogin=function(){var e=this;if(this.logger.debug("zb.rh.tl call"),this.stateCenter.runState===r.ENUM_RUN_STATE.trylogin){if(++this.stateCenter.tryLoginCount>r.MAX_TRY_LOGIN_COUNT){this.logger.error("zb.rh.tl fail times limit");var t=this.stateCenter.lastRunState;return this.setRunState(r.ENUM_RUN_STATE.logout),this.resetRoom(),void(t==r.ENUM_RUN_STATE.login?(this.logger.error("zb.rh.tl fail and disconnect"),this.onDisconnect(r.sdkErrorList.LOGIN_DISCONNECT)):(this.logger.info("zb.rh.tl fail and callback user"),i.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(r.sdkErrorList.LOGIN_TIMEOUT)))}if(this.stateCenter.startConnceTime=(new Date).getTime(),console.warn("start connect",this.stateCenter.startConnceTime),this.socketCenter.isDisConnect()){this.logger.debug("zb.rh.tl need new websocket");try{this.socketCenter.closeSocket(),this.logger.debug("zb.rh.tl new websocket"),this.socketCenter.createSocket(this.stateCenter.server),this.socketCenter.registerRouter("login",function(t,s){e.handleLoginRsp(t,s)}),this.socketCenter.closeHandler(function(t){e.socketCenter.closeSocket(),e.closeHandler(t)}),this.socketCenter.openHandler(function(){e.openHandler()})}catch(e){this.logger.error("zb.rh.tl websocket err:"+e)}}else{var s=this.loginBodyData();this.logger.info("zb.rh.tl use current websocket and sent login"),this.socketCenter.sendMessage("login",s)}this.stateCenter.tryLoginTimer=setTimeout(function(){e.tryLogin()},r.TRY_LOGIN_INTERVAL[this.stateCenter.tryLoginCount%r.MAX_TRY_LOGIN_COUNT]),this.logger.info("zb.rh.tl call success")}else this.logger.error("zb.rh.tl state error")},e.prototype.handleLoginRsp=function(e,t){if(this.logger.debug("zb.rh.hlr call"),this.stateCenter.runState===r.ENUM_RUN_STATE.trylogin){if(e.header.seq===t)return 0!==e.body.err_code?(this.handleLoginFail(e),void this.logger.error("zb.rh.hlr server error=",e.body.err_code)):(this.handleLoginSuccess(e),void this.logger.info("zb.rh.hlr call success."));this.logger.error("zb.rh.hlr in wrong seq, local=",t,",recv=",e.header.seq)}else this.logger.error("zb.rh.hlr state error")},e.prototype.handleLoginFail=function(e){if(this.logger.debug("zb.rh.hlf call"),i.ClientUtil.isKeepTryLogin(e.body.err_code))this.logger.warn("zb.rh.hlf KeepTry true");else{var t=this.stateCenter.lastRunState;this.setRunState(r.ENUM_RUN_STATE.logout),this.resetRoom();var s=i.ClientUtil.getServerError(e.body.err_code);t===r.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.hlf callback disconnect"),this.onDisconnect(s)):(this.logger.info("zb.rh.hlf callback error"),i.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(s)),this.logger.debug("zb.rh.hlf call success")}},e.prototype.handleLoginSuccess=function(e){this.stateCenter.startloginSucTime=(new Date).getTime(),console.warn("login suc",this.stateCenter.startloginSucTime,this.stateCenter.startloginSucTime-this.stateCenter.startloginTime,this.stateCenter.startloginSucTime-this.stateCenter.startConnceTime),this.logger.info("zb.rh.hls call");var t=this.stateCenter.lastRunState;if(this.setRunState(r.ENUM_RUN_STATE.login),this.stateCenter.userid=e.body.user_id,this.stateCenter.sessionid=e.body.session_id,this.stateCenter.anchor_info=e.body.anchor_info||this.stateCenter.anchor_info,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.userid,this.stateCenter.idName,this.stateCenter.sessionid,r.PROTO_VERSION),e.body.config_info&&(this.logger.setRemoteLogLevel(e.body.config_info.log_level),""!=e.body.config_info.log_url&&this.logger.openLogServer(e.body.config_info.log_url)),void 0!=e.body.ret_timestamp&&"string"==typeof e.body.ret_timestamp){var s=parseFloat(e.body.ret_timestamp);this.stateCenter.serverTimeOffset=0==s?0:e.body.ret_timestamp-(new Date).getTime()}e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),this.resetTryLogin(),this.loginSuccessCallBack(t,e)},e.prototype.openHandler=function(){this.logger.info("zb.rh.oh websocket.onpen call"),this.socketCenter.responseHandler();var e=this.loginBodyData();this.logger.info("zb.rh.oh websocket.onpen send login"),this.stateCenter.startloginTime=(new Date).getTime(),console.warn("start login",this.stateCenter.startloginTime,this.stateCenter.startloginTime-this.stateCenter.startConnceTime),this.socketCenter.sendMessage("login",e),this.logger.debug("zb.rh.oh websocket.onpen call success")},e.prototype.closeHandler=function(e){this.logger.info("zb.rh.ws.oc msg="+JSON.stringify(e)),this.stateCenter.runState!==r.ENUM_RUN_STATE.logout?this.stateCenter.runState===r.ENUM_RUN_STATE.trylogin&&this.stateCenter.tryLoginCount<=r.MAX_TRY_LOGIN_COUNT?this.logger.info("zb.rh.ws.oc is called because of try login"):this.stateCenter.runState===r.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.ws.oc is called because of network broken, try again"),this.setRunState(r.ENUM_RUN_STATE.trylogin),this.resetTryLogin(),this.tryLogin()):(this.logger.error("zb.rh.ws.oc out of think!!!"),this.setRunState(r.ENUM_RUN_STATE.logout),this.resetRoom(),this.onDisconnect(r.sdkErrorList.UNKNOWN)):this.logger.info("zb.rh.ws.oc onclose logout flow call websocket.close")},e.prototype.logout=function(){return this.logger.debug("zb.rh.lo call"),this.stateCenter.runState===r.ENUM_RUN_STATE.logout?(this.logger.warn("zb.rh.lo at logout"),!1):(this.resetRoom(),this.logger.info("zb.rh.lo call success"),!0)},e.prototype.setUserStateUpdate=function(e){return this.logger.debug("zb.rh.su call"),"boolean"!=typeof e?(this.logger.info("zb.rh.su param error"),!1):(this.stateCenter.userStateUpdate=e,this.logger.info("zb.rh.su call success "+e),!0)},e.prototype.fetchUserList=function(){this.logger.debug("zb.rh.ful call"),this.stateCenter.userQuerying?this.logger.warn("zb.rh.ful is already querying"):(this.stateCenter.userQuerying=!0,this.stateCenter.userTempList=[],"V1"===r.ROOMVERSION?this.fetchUserListWithPage(0):this.fetchUserListWithPageV2(0),this.logger.info("zb.rh.ful the first time call"))},e.prototype.fetchUserListWithPageV2=function(e){var t=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list_v2",function(s){t.handleFetchUserListRspV2(e,s)}),this.socketCenter.sendMessage("user_list_v2",{marker:0===e?"":e+"",mode:0,limit:100}),this.logger.info("zb.rh.fulwp call success")},e.prototype.fetchUserListWithPage=function(e){var t=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list",function(e){t.handleFetchUserListRsp(e)}),this.socketCenter.sendMessage("user_list",{user_index:e,sort_type:0}),this.logger.info("zb.rh.fulwp call success")},e.prototype.handleFetchUserListRspV2=function(e,t){if(this.logger.debug("zb.rh.hfulr call"),0!=t.body.err_code)return this.stateCenter.userQuerying=!1,void this.logger.info("zb.rh.hfulr fetch error "+t.body.err_code);if(this.stateCenter.userStateUpdate){if(this.stateCenter.userTempList=this.stateCenter.userTempList.concat(t.body.user_baseinfos),e!=t.body.marker)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPageV2(e+1);this.stateCenter.userSeq=t.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var s=[],r=0;r<this.stateCenter.userTempList.length;r++){var i={idName:this.stateCenter.userTempList[r].id_name,nickName:this.stateCenter.userTempList[r].nick_name,role:this.stateCenter.userTempList[r].role};s.push(i)}this.stateCenter.userQuerying=!1,this.onGetTotalUserList(this.stateCenter.roomid,s),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+s+" count "+s.length)}},e.prototype.handleFetchUserListRsp=function(e){if(this.logger.debug("zb.rh.hfulr call"),0!=e.body.err_code)return this.stateCenter.userQuerying=!1,void this.logger.info("zb.rh.hfulr fetch error "+e.body.err_code);if(this.stateCenter.userStateUpdate){this.stateCenter.userTempList=this.stateCenter.userTempList.concat(e.body.user_baseinfos);var t=e.body.ret_user_index;if(t!=e.body.server_user_index)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPage(t+1);this.stateCenter.userSeq=e.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var s=[],r=0;r<this.stateCenter.userTempList.length;r++){var i={idName:this.stateCenter.userTempList[r].id_name,nickName:this.stateCenter.userTempList[r].nick_name,role:this.stateCenter.userTempList[r].role};s.push(i)}this.stateCenter.userQuerying=!1,this.onGetTotalUserList(this.stateCenter.roomid,s),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+s+" count "+s.length)}},e.prototype.handleLogoutRsp=function(e){this.logger.debug("zb.rh.hlor result=",e.body.err_code)},e.prototype.handlePushUserStateUpdateMsg=function(e){if(this.logger.info("zb.rh.hpus call"),this.stateCenter.isLogin())if(this.stateCenter.userStateUpdate){if(this.stateCenter.userSeq+e.body.user_actions.length!==e.body.user_list_seq)return this.logger.warn("zb.rh.hpus fetch new userlist "+this.stateCenter.userSeq,NaN+e.body.user_list_seq),void this.fetchUserList();this.stateCenter.userSeq=e.body.user_list_seq,this.logger.debug("zb.rh.hpus push userSeq "+this.stateCenter.userSeq);for(var t=[],s=0;s<e.body.user_actions.length;s++){var r={action:e.body.user_actions[s].Action,idName:e.body.user_actions[s].IdName,nickName:e.body.user_actions[s].NickName,role:e.body.user_actions[s].Role,loginTime:e.body.user_actions[s].LoginTime};t.push(r)}this.onUserStateUpdate(e.body.room_id,t),this.logger.info("zb.rh.hpus call success")}else this.logger.error("zb.rh.hpus no userStateUpdate flag");else this.logger.error("zb.rh.hpus not login")},e.prototype.onUserStateUpdate=function(e,t){},e}();t.RoomHandler=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=s(1),o=function(){function e(e,t){var s=this;this.cmdSeq=0,this.responseRouters={},this.logger=e,this.stateCenter=t,this.responseRouters={push_kickout:function(e){s.handlePushKickout(e)},push_custommsg:function(e){s.handlePushCustomMsg(e)},push_im_chat:function(e){s.handlePushRoomMsg(e)},push_userlist_update:function(e){s.handlePushUserStateUpdateMsg(e)},push_merge_message:function(e){s.handlePushMergeMsg(e)},trans:function(e){s.handleTransRsp(e)},push_trans:function(e){s.handlePushTransMsg(e)}}}return e.prototype.handlePushKickout=function(e){},e.prototype.handlePushCustomMsg=function(e){},e.prototype.handlePushRoomMsg=function(e){},e.prototype.handlePushUserStateUpdateMsg=function(e){},e.prototype.handlePushMergeMsg=function(e){},e.prototype.handlePushTransMsg=function(e){},e.prototype.handleBigImMsgRsp=function(e){},e.prototype.handleTransRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){var t=e.body.trans_type;this.stateCenter.transSeqMap[t]?(this.stateCenter.transSeqMap[t].seq=e.body.trans_seq,this.logger.debug("zb.sc.htr trans "+t+" seq "+e.body.trans_seq)):this.logger.error("zb.sc.htr cannot match send info")}else this.logger.error("zb.sc.htr trans send error "+e.body.err_code);else this.logger.error("zb.sc.htr not login")},e.prototype.handleBizChannelRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.cmd,e.body.rsp_body):null!=t.error&&t.error(e.body.err_code,e.header.seq,e.body.rsp_body)},e.prototype.registerRouter=function(e,t){this.responseRouters[e]=t},e.prototype.getSocket=function(e){return null},e.prototype.getHeaderV2=function(e){return{Protocol:"req_v2",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.getHeader=function(e){return{Protocol:"req",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.sendMessage=function(e,t,s,i){if(this.logger.debug("zb.sc.sm call "+e),this.isDisConnect())return this.logger.error("zb.sc.sm error  "+e),-1;var o="V1"===r.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),n={header:o,body:t};if(void 0==s&&(s=null),void 0==i&&(i=null),null!=s||null!=i){var a={data:n,seq:o.seq,deleted:!1,time:Date.parse(new Date+""),success:s,error:i},l=this.stateCenter.sendCommandList.push(a);this.stateCenter.sendCommandMap[a.seq]=l}return this.websocket.send(JSON.stringify(n)),this.logger.debug("zb.sc.sm success"),o.seq},e.prototype.sendCustomMessage=function(e,t,s,i){if(this.logger.debug("zb.sc.scm call"),this.isDisConnect())return this.logger.error("zb.sc.scm error"),!1;var o="V1"===r.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),n={header:o,body:t},a=JSON.stringify(n);void 0==s&&(s=null),void 0==i&&(i=null);var l={data:n,seq:o.seq,deleted:!1,time:Date.parse(new Date+""),success:s,error:i},h=this.stateCenter.sendDataList.push(l);return this.stateCenter.sendDataMap[l.seq]=h,this.websocket.send(a),this.logger.debug("zb.sc.scm success seq: ",o.seq),!0},e.prototype.isDisConnect=function(){return!this.websocket||1!==this.websocket.readyState},e.prototype.closeSocket=function(){this.websocket&&(this.logger.info("zb.sc.cs close websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.createSocket=function(e){this.websocket=this.getSocket(e)},e.prototype.openHandler=function(e){this.websocket.onopen=e},e.prototype.closeHandler=function(e){this.websocket.onclose=e},e.prototype.errorHandler=function(){var e=this;this.websocket.onerror=function(t){e.logger.error("zb.sc.oe msg="+JSON.stringify(t))}},e.prototype.checkResponse=function(e){return(e.header.appid!==this.stateCenter.appid||e.header.session_id!==this.stateCenter.sessionid||e.header.user_id!==this.stateCenter.userid||e.header.room_id!==this.stateCenter.roomid||this.stateCenter.runState!==r.ENUM_RUN_STATE.login)&&(this.logger.error("zb.sc.crp check session fail."),!0)},e.prototype.responseHandler=function(){var e=this;this.websocket.onmessage=function(t){var s=JSON.parse(t.data);e.logger.info("zb.sc.ws.rph jsonmsg= ",s.header.cmd),"login"!==s.header.cmd?e.checkResponse(s)?e.logger.error("zb.sc.ws.rph check session fail."):(e.handleSendCommandMsgRsp(s),e.logger.info("zb.sc.ws.rph cmd="+s.header.cmd+",function="+!!e.responseRouters[s.header.cmd]),e.responseRouters[s.header.cmd]&&e.responseRouters[s.header.cmd](s)):e.responseRouters.login(s,e.cmdSeq)}},e.prototype.handleSendCommandMsgRsp=function(e){this.logger.debug("zb.sc.hscmr call");var t,s=this.stateCenter.sendCommandMap[e.header.seq];null!=s&&("login"==(t=s._data).data.header.cmd?this.logger.debug("zb.sc.hscmr don't check "+t.data.header.cmd):"relay"==t.data.header.cmd?this.handleRelayRspCallback(e,t):"bigim_chat"==t.data.header.cmd?this.handleBigImRspCallback(e,t):"biz_channel"==t.data.header.cmd?this.handleBizChannelRspCallback(e,t):0===e.body.err_code?null!=t.success&&t.success(e.header.seq):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq),delete this.stateCenter.sendCommandMap[e.header.seq],this.stateCenter.sendCommandList.remove(s)),this.logger.debug("zb.sc.hscmr call success")},e.prototype.handleRelayRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.relay_result):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e.prototype.handleBigImRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&this.handleBigImMsgRsp(e):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e}();t.SocketCenter=o},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0),i=function(){function e(){}return e.prototype.onPlayStateUpdateHandle=function(e,t,s){1==e&&this.stopPlayingStream(t),this.onPlayStateUpdate(e,t,s)},e.prototype.onPublishStateUpdateHandle=function(e,t,s){var i=this;0==e?this.stateCenter.publishStreamList[t]&&(this.stateCenter.publishStreamList[t].state==r.ENUM_PUBLISH_STREAM_STATE.tryPublish?(this.stateCenter.publishStreamList[t].state=r.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(t,r.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info,function(e){i.stateCenter.publishStreamList[t]&&i.stateCenter.publishStreamList[t].state==r.ENUM_PUBLISH_STREAM_STATE.update_info&&(i.stateCenter.publishStreamList[t].state=r.ENUM_PUBLISH_STREAM_STATE.stop,i.onPublishStateUpdate(1,t,e),i.streamCenter.stopPlayingStream(t))})):this.WebrtcOnPublishStateUpdateHandle(e,t,s)):(this.onPublishStateUpdate(e,t,s),1==e&&this.stopPublishingStream(t))},e.prototype.resetStreamCenter=function(){if(this.stateCenter.customUrl&&(this.stateCenter.customUrl=null),this.streamCenter.reset(),!this.socketCenter.isDisConnect())for(var e in this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[e].state==r.ENUM_PUBLISH_STREAM_STATE.publishing&&this.streamHandler.updateStreamInfo(e,r.ENUM_STREAM_SUB_CMD.liveEnd,this.stateCenter.publishStreamList[e].extra_info)},e.prototype.handleFetchWebRtcUrlRsp=function(e){var t=e.body.stream_id;if("push"===e.body.ptype)this.stateCenter.publishStreamList[t]?this.streamCenter.startPublishingStream(t,e.body.urls):this.logger.error("cb.cm.hfwur no streamid to publish");else if("pull"==e.body.ptype){for(var s=!1,r=0;r<this.stateCenter.streamList.length;r++)if(this.stateCenter.streamList[r].stream_id===t){s=!0;break}0==s&&this.logger.warn("cb.cm.hfwur cannot find stream, continue to play"),this.streamCenter.startPlayingStream(t,e.body.urls)}},e}();t.Common=i},function(e,t,s){"use strict";var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])},function(e,t){function s(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var o=s(11),n=s(0),a=s(1),l=s(10),h=s(9),u=s(8),d=s(7),c=s(6),g=s(5),p=function(e){function t(){return e.call(this)||this}return i(t,e),t.prototype.init=function(){this.bindSocketHandler(),this.bindStreamHandler(),this.bindHeatBeatHandler(),this.bindRoomHandler(),this.bindMessageHandler(),this.bindLiveHandler(),this.bindStreamCenterHandler()},t.prototype.kickout=function(){this.socketCenter.handlePushKickout({body:{reason:"test"}})},t.prototype.bindSocketHandler=function(){var e=this;this.socketCenter=new l.SocketCenter(this.logger,this.stateCenter),this.socketCenter.registerRouter("push_signal",function(t){e.liveHandler.handlePushSignalMsg(t)}),this.socketCenter.getSocket=function(t){return e.getSocket(t)},this.socketCenter.handlePushKickout=function(t){e.logger.info("zb.cm.bsh.0  call hpk"),e.roomHandler.setRunState(n.ENUM_RUN_STATE.logout),e.roomHandler.resetRoom(),e.onKickOut({code:n.sdkErrorList.KICK_OUT.code,msg:n.sdkErrorList.KICK_OUT.msg+t.body.reason}),e.logger.debug("zb.cm.bsh.0  call hpk success")},this.socketCenter.handlePushCustomMsg=function(t){e.messageHandler.handlePushCustomMsg(t)},this.socketCenter.handlePushUserStateUpdateMsg=function(t){e.roomHandler.handlePushUserStateUpdateMsg(t)},this.socketCenter.handlePushRoomMsg=function(t){e.onRecvRoomMsg(t.body.chat_data,t.body.server_msg_id,t.body.ret_msg_id)},this.socketCenter.handlePushMergeMsg=function(t){e.messageHandler.handlePushMergeMsg(t)},this.socketCenter.handlePushTransMsg=function(t){e.messageHandler.handlePushTransMsg(t)},this.socketCenter.handleBigImMsgRsp=function(t){e.messageHandler.handleBigImMsgRsp(t)}},t.prototype.bindStreamHandler=function(){var e=this;this.streamHandler=new u.StreamHandler(this.logger,this.stateCenter,this.socketCenter),this.streamHandler.onStreamUpdated=function(t,s){e.onStreamUpdated(t,s)},this.streamHandler.onPublishStateUpdate=function(t,s,r){e.onPublishStateUpdate(t,s,r)},this.streamHandler.onStreamExtraInfoUpdated=function(t){e.onStreamExtraInfoUpdated(t)},this.streamHandler.setCDNInfo=function(t,s){e.setCDNInfo(t,s)}},t.prototype.bindHeatBeatHandler=function(){var e=this;this.heartBeatHandler=new d.HeartBeatHandler(this.logger,this.stateCenter,this.socketCenter),this.heartBeatHandler.onRecvReliableMessage=function(t,s,r){e.onRecvReliableMessage(t,s,r)},this.heartBeatHandler.handleFetchStreamListRsp=function(t){e.streamHandler.handleFetchStreamListRsp(t)},this.heartBeatHandler.fetchUserList=function(){e.roomHandler.fetchUserList()},this.heartBeatHandler.onUpdateOnlineCount=function(t,s){e.onUpdateOnlineCount(t,s)},this.heartBeatHandler.updateStreamInfo=function(t,s,r,i){void 0===r&&(r=""),e.streamHandler.updateStreamInfo(t,s,r,i)},this.heartBeatHandler.hbLogout=function(t){e.onDisconnect(t)}},t.prototype.bindRoomHandler=function(){var e=this;this.roomHandler=new h.RoomHandler(this.logger,this.stateCenter,this.socketCenter),this.roomHandler.loginSuccessCallBack=function(t,s){var r=s.body.hearbeat_interval<n.MINIUM_HEARTBEAT_INTERVAL?n.MINIUM_HEARTBEAT_INTERVAL:s.body.hearbeat_interval;e.heartBeatHandler.start(r),e.heartBeatHandler.resetCheckMessage(),e.heartBeatHandler.startCheckMessageTimeout(),e.streamCenter.setSessionInfo(e.stateCenter.appid,e.stateCenter.idName,e.stateCenter.token,e.stateCenter.testEnvironment),s.body.anchor_info&&e.onGetAnchorInfo(s.body.anchor_info.anchor_id_name,s.body.anchor_info.anchor_nick_name),s.body.online_count&&e.onUpdateOnlineCount(e.stateCenter.roomid,s.body.online_count),e.logger.info("zb.cm.brh hls userStateUpdate "+e.stateCenter.userStateUpdate),e.stateCenter.userStateUpdate&&(e.logger.info("zb.cm.brh hls fetch all new userlist"),e.roomHandler.fetchUserList()),e.streamHandler.handleStreamStart(t,s)},this.roomHandler.onGetTotalUserList=function(t,s){e.onGetTotalUserList(t,s)},this.roomHandler.resetRoomCallBack=function(){e.heartBeatHandler.resetHeartbeat(),e.heartBeatHandler.resetCheckMessage(),e.resetStreamCenter()},this.roomHandler.onUserStateUpdate=function(t,s){e.onUserStateUpdate(t,s)},this.roomHandler.onDisconnect=function(t){e.onDisconnect(t)},this.roomHandler.loginBodyData=function(){return e.loginBodyData()}},t.prototype.bindMessageHandler=function(){var e=this;this.messageHandler=new c.MessageHandler(this.logger,this.stateCenter,this.socketCenter),this.messageHandler.onRecvCustomCommand=function(t,s,r){e.onRecvCustomCommand(t,s,r)},this.messageHandler.onRecvBigRoomMessage=function(t,s){e.onRecvBigRoomMessage(t,s)},this.messageHandler.onRecvReliableMessage=function(t,s,r){e.onRecvReliableMessage(t,s,r)}},t.prototype.bindLiveHandler=function(){var e=this;this.liveHandler=new g.LiveHandler(this.logger,this.stateCenter,this.socketCenter),this.liveHandler.onRecvEndJoinLiveCommand=function(t,s,r,i){e.onRecvEndJoinLiveCommand(t,s,r,i)},this.liveHandler.onRecvInviteJoinLiveRequest=function(t,s,r,i){e.onRecvInviteJoinLiveRequest(t,s,r,i)},this.liveHandler.onRecvJoinLiveRequest=function(t,s,r,i){e.onRecvJoinLiveRequest(t,s,r,i)}},t.prototype.bindStreamCenterHandler=function(){var e=this;this.streamCenter.onPlayStateUpdate=function(t,s,r){e.onPlayStateUpdateHandle(t,s,r)},this.streamCenter.onPlayQualityUpdate=function(t,s){e.onPlayQualityUpdate(t,s)},this.streamCenter.onPublishStateUpdate=function(t,s,r){e.onPublishStateUpdateHandle(t,s,r)},this.streamCenter.onPublishQualityUpdate=function(t,s){e.onPublishQualityUpdate(t,s)},this.streamCenter.onPlayerStreamUrlUpdate=function(t,s,r){e.onStreamUrlUpdate(t,s,r)},this.streamCenter.onVideoSizeChanged=function(t,s,r){e.onVideoSizeChanged(t,s,r)}},t.prototype.config=function(e){return this.logger.debug("zb.cm.cf call"),a.ClientUtil.checkConfigParam(e,this.logger)?(this.stateCenter.appid=e.appid,this.stateCenter.server=e.server,this.stateCenter.idName=e.idName,this.stateCenter.nickName=e.nickName,this.logger.setLogLevel(e.logLevel),!1===e.audienceCreateRoom&&(this.stateCenter.roomCreateFlag=0),e.remoteLogLevel?this.logger.setRemoteLogLevel(0):this.logger.setRemoteLogLevel(e.remoteLogLevel),this.logger.setSessionInfo(e.appid,"","",e.idName,"",n.PROTO_VERSION),e.logUrl&&this.logger.openLogServer(e.logUrl),-1!=this.stateCenter.server.indexOf("test2-wsliveroom-api.zego.im")&&(this.stateCenter.testEnvironment=!0),this.stateCenter.configOK=!0,this.logger.debug("zb.cm.cf call success"),!0):(this.logger.error("zb.cm.cf param error"),!1)},t.prototype.login=function(e,t,s,r,i){this.roomHandler.login(e,t,s,null,r,i)},t.prototype.loginWithAuthor=function(e,t,s,r,i,o){this.roomHandler.login(e,t,s,r,i,o)},t.prototype.logout=function(){return this.roomHandler.logout()},t.prototype.setUserStateUpdate=function(e){this.roomHandler.setUserStateUpdate(e)},t.prototype.onUserStateUpdate=function(e,t){},t.prototype.onGetTotalUserList=function(e,t){},t.prototype.onUpdateOnlineCount=function(e,t){},t.prototype.onGetAnchorInfo=function(e,t){},t.prototype.release=function(){this.logger.debug("zb.cm.rl call"),this.roomHandler.setRunState(n.ENUM_RUN_STATE.logout),this.roomHandler.resetRoom(),this.logger.stopLogServer(),this.logger.debug("zb.cm.rl call success")},t.prototype.sendCustomCommand=function(e,t,s,r){return this.messageHandler.sendCustomCommand(e,t,s,r)},t.prototype.onRecvCustomCommand=function(e,t,s){},t.prototype.sendRoomMsg=function(e,t,s,r,i){this.messageHandler.sendRoomMsg(e,t,s,r,i)},t.prototype.onRecvRoomMsg=function(e,t,s){},t.prototype.sendReliableMessage=function(e,t,s,r){this.messageHandler.sendReliableMessage(e,t,s,r)},t.prototype.onRecvReliableMessage=function(e,t,s){},t.prototype.sendBigRoomMessage=function(e,t,s,r,i){this.messageHandler.sendBigRoomMessage(e,t,s,r,i)},t.prototype.onRecvBigRoomMessage=function(e,t){},t.prototype.sendRelayMessage=function(e,t,s,r){this.messageHandler.sendRelayMessage(e,t,s,r)},t.prototype.requestJoinLive=function(e,t,s,r){return this.liveHandler.requestJoinLive(e,t,s,r)},t.prototype.onRecvJoinLiveRequest=function(e,t,s,r){},t.prototype.inviteJoinLive=function(e,t,s,r){return this.liveHandler.inviteJoinLive(e,t,s,r)},t.prototype.onRecvInviteJoinLiveRequest=function(e,t,s,r){},t.prototype.endJoinLive=function(e,t,s){return this.liveHandler.endJoinLive(e,t,s)},t.prototype.onRecvEndJoinLiveCommand=function(e,t,s,r){},t.prototype.respondJoinLive=function(e,t,s,r){return this.liveHandler.respondJoinLive(e,t,s,r)},t.prototype.updateMixStream=function(e,t,s){return this.streamHandler.updateMixStream(e,t,s)},t.prototype.stopMixStream=function(e,t,s){return this.streamHandler.stopMixStream(e,t,s)},t.prototype.updateStreamExtraInfo=function(e,t){return this.streamHandler.updateStreamExtraInfo(e,t)},t.prototype.onStreamUrlUpdate=function(e,t,s){},t.prototype.onStreamUpdated=function(e,t){},t.prototype.onStreamExtraInfoUpdated=function(e){},t.prototype.onPlayStateUpdate=function(e,t,s){},t.prototype.onVideoSizeChanged=function(e,t,s){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,s){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onDisconnect=function(e){},t.prototype.onKickOut=function(e){},t.getCurrentVersion=function(){return n.PROTO_VERSION},t}(o.Common);t.BaseCenter=p},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(0);t.D=["00","01","02","03","04","05","06","07","08","09"];var i=function(){function e(){this.logUploadTimer=null,this.logUploadInterval=1e4,this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}return e.prototype.setLogLevel=function(e){this.logLevel<r.ENUM_LOG_LEVEL.debug||this.logLevel>r.ENUM_LOG_LEVEL.report?this.logLevel=r.ENUM_LOG_LEVEL.disable:this.logLevel=e},e.prototype.setRemoteLogLevel=function(e){this.logRemoteLevel<r.ENUM_LOG_LEVEL.debug||this.logRemoteLevel>r.ENUM_LOG_LEVEL.report?this.logRemoteLevel=r.ENUM_LOG_LEVEL.disable:this.logRemoteLevel=e},e.prototype.setSessionInfo=function(e,t,s,r,i,o){this.appid=e,this.roomid=t,this.sessionid=s,this.userid=r,this.userName=i,this.version=o},e.prototype.openLogServer=function(e){try{e.startsWith("wss:")?(this.logType=r.ENUM_REMOTE_TYPE.websocket,this.openWebSocketLogServer(e)):e.startsWith("https:")?(this.logType=r.ENUM_REMOTE_TYPE.https,this.openHttpsLogServer(e)):this.logType=r.ENUM_REMOTE_TYPE.disable}catch(e){this.error(JSON.stringify(e))}},e.prototype.stopLogServer=function(){this.logType==r.ENUM_REMOTE_TYPE.websocket?this.stopWebSocketServer():this.logType==r.ENUM_REMOTE_TYPE.https&&(this.SendHttpsLog(),this.stopHttpsServer()),this.logType=r.ENUM_REMOTE_TYPE.disable},e.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.openHttpsLogServer=function(e){var t=this;this.url=e,e&&(this.stopHttpsServer(),this.logUploadTimer||(this.logUploadTimer=setInterval(function(){t.SendHttpsLog()},this.logUploadInterval)))},e.prototype.stopHttpsServer=function(){this.logUploadTimer&&(clearInterval(this.logUploadTimer),this.logUploadTimer=null)},e.prototype.report=function(e){var t=this.logReportParamList(r.ENUM_LOG_LEVEL.report,e);this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=r.ENUM_LOG_LEVEL.report&&console.debug.apply(console,t),this.RemoteLog(r.ENUM_LOG_LEVEL.report,t,!0)},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=this.logParamList(r.ENUM_LOG_LEVEL.debug,e.join(""));this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=r.ENUM_LOG_LEVEL.debug&&console.debug.apply(console,s),this.log(r.ENUM_LOG_LEVEL.debug,s)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=this.logParamList(r.ENUM_LOG_LEVEL.info,e.join(""));this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=r.ENUM_LOG_LEVEL.info&&console.info.apply(console,s),this.log(r.ENUM_LOG_LEVEL.info,s)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=this.logParamList(r.ENUM_LOG_LEVEL.warn,e.join(""));this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=r.ENUM_LOG_LEVEL.warn&&console.warn.apply(console,s),this.log(r.ENUM_LOG_LEVEL.warn,s)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=this.logParamList(r.ENUM_LOG_LEVEL.error,e.join(""));this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=r.ENUM_LOG_LEVEL.error&&console.error.apply(console,s),this.log(r.ENUM_LOG_LEVEL.error,s)},e.prototype.log=function(e,t){if(this.logLevel!==r.ENUM_LOG_LEVEL.disable&&this.logLevel<=e)for(this.logCache.push(t);this.logCache.length>this.logCacheMax;)this.logCache.shift();this.logRemoteLevel!==r.ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=e&&this.RemoteLog(e,t)},e.prototype.RemoteLog=function(e,t,s){void 0===s&&(s=!1),""!=this.url&&(this.logType==r.ENUM_REMOTE_TYPE.websocket?this.RemoteWebSocketLog(e,t):this.logType==r.ENUM_REMOTE_TYPE.https&&this.RemoteHttpsLog(e,t,s))},e.prototype.RemoteWebSocketLog=function(e,t){if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var s=this.url;this.url="",this.openLogServer(s),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(1==this.websocket.readyState){if(this.logCacheSend.length>0){for(var r="",i=0;i<this.logCacheSend.length;i++)r=r+this.logCacheSend[i]+"\n";t=r+t,this.logCacheSend=[]}this.websocket.send(t)}else console.warn("wrong socket state:"+this.websocket.readyState),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)},e.prototype.RemoteHttpsLog=function(e,t,s){this.logCacheSend.push(t),(this.logCacheSend.length>=this.logCacheMax||!0===s)&&this.SendHttpsLog()},e.prototype.logParamList=function(e,s){var r=new Date,i=r.getFullYear()+"/";i+=(t.D[r.getMonth()+1]||r.getMonth()+1)+"/",i+=(t.D[r.getDate()]||r.getDate())+" ",i+=(t.D[r.getHours()]||r.getHours())+":",i+=(t.D[r.getMinutes()]||r.getMinutes())+":",i+=t.D[r.getSeconds()]||r.getSeconds(),i+="."+r.getTime()%1e3;var o=s.substr(0,s.indexOf(" "));0==o.length&&(o=s);var n=s.substr(s.indexOf(" ")+1);0==n.length&&(n="");var a={time:i,level:e,action:o,content:n,appid:this.appid,roomid:this.roomid,userid:this.userid,userName:this.userName,sessionid:this.sessionid};return[JSON.stringify(a)]},e}();t.Logger=i},function(e,t,s){"use strict";var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])},function(e,t){function s(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var o=s(13),n=s(2),a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.openWebSocketLogServer=function(e){if(this.url!=e){if(this.url=e,this.stopWebSocketServer(),!e)return;this.websocket=new n.ZegoWebSocket(e),this.websocket.onopen=function(e){},this.websocket.onclose=function(e){},this.websocket.onmessage=function(e){},this.websocket.onerror=function(e){console.error("open log websocket error:"+e)}}},t.prototype.SendHttpsLog=function(){var e=this;if(0!=this.logCacheSend.length){var t=this.logCacheSend.join("\n");wx.request({url:this.url,data:t,method:"POST",success:function(t){if(0!=t.data.length){var s=t&&t.data&&t.data.interval;"number"==typeof s&&e.logUploadInterval!==s&&(e.timeInterval=s,e.openHttpsLogServer(e.url))}},fail:function(e){console.log("send failed "+e.statusCode)}}),this.logCacheSend=[]}},t.prototype.logReportParamList=function(e,t){var s=new Date,r=s.getFullYear()+"/";return r+=(o.D[s.getMonth()+1]||s.getMonth()+1)+"/",r+=(o.D[s.getDate()]||s.getDate())+" ",r+=(o.D[s.getHours()]||s.getHours())+":",r+=(o.D[s.getMinutes()]||s.getMinutes())+":",r+=o.D[s.getSeconds()]||s.getSeconds(),r+="."+s.getTime()%1e3,t.time=r,t.level=e,t.console="xcx",t.appid=this.appid,t.roomid=this.roomid,t.userid=this.userid,t.id_name=this.userid,t.userName=this.userName,t.sessionid=this.sessionid,t.version=this.version,[JSON.stringify(t)]},t}(o.Logger);t.LoggerWechat=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={start:0,playing:1,stop:2},i=function(){function e(e,t,s,i,o,n,a,l,h){this.playUrlIndex=0,this.playUrlTryCount=0,this.currentUrl=null,this.reconnectCount=0,this.state=r.stop,this.playerSeq=0,this.publishQualitySeq=0,this.publishQualityCount=0,this.publishQulaityMaxCount=30,this.everSuccess=!1,this.streamid=t,this.urls=s,this.reconnectLimit=o,this.logger=e,this.streamCenter=n,this.sourceType=a,this.playerType=l,this.params=i,this.dataReport=h}return e.prototype.resetPlayer=function(){this.state=r.stop},e.prototype.newPlayer=function(){this.resetPlayer();var e=this.getCurrentPlayerUrl(),t=e;return 0!=this.params.length&&(t=e+"?"+this.params),e!==this.currentUrl?(this.currentUrl=e,this.streamCenter.onStreamUrlUpdate(this.streamid,t,this.playerType)):this.streamCenter.onPlayerRetry(this.streamid,this.playerType),0==this.everSuccess?0==this.playerType?(this.dataReport.eventStart(this.playerSeq,"PlayBegin"),this.dataReport.addEventInfo(this.playerSeq,"PlayBegin","url",t)):(this.dataReport.eventStart(this.playerSeq,"PublishBegin"),this.dataReport.addEventInfo(this.playerSeq,"PublishBegin","url",t)):0==this.playerType?this.dataReport.addEventInfo(this.playerSeq,"PlayRetry","url",t):this.dataReport.addEventInfo(this.playerSeq,"PublishRetry","url",t),this.state=r.start,!0},e.prototype.stopPlayer=function(){0==this.playerType?this.dataReport.eventEndWithMsg(this.playerSeq,"PlayStat",{quality:this.playerInfo}):(this.dataReport.addEventInfo(this.playerSeq,"PublishStat","quality",this.playerInfo),this.dataReport.eventEndWithMsg(this.playerSeq,"PublishStat",{quality:this.playerInfo}))},e.prototype.tryStartPlayer=function(e){for(;this.playUrlTryCount<this.urls.length;)if(++this.reconnectCount>this.reconnectLimit)this.playUrlTryCount++,this.playUrlIndex=(this.playUrlIndex+1)%this.urls.length,this.reconnectCount=0;else if(this.logger.info("zp.tsp.0 index: "+this.playUrlIndex+", url: "+this.getCurrentPlayerUrl()),this.newPlayer())break;if(this.playUrlTryCount>=this.urls.length){this.logger.info("zp.tsp.0 stream: "+this.streamid),this.resetPlayer();var t="";0==this.playerType?t="PlayEnd":1==this.playerType&&(t="PublishEnd",this.reportQualityStatics());var s={error:e,reason:"no url to retry"};this.dataReport.addEvent(this.playerSeq,t,s),this.streamCenter.onPlayerStop(this.streamid,this.playerType,e)}},e.prototype.shouldRetryPlay=function(e){var t=e.detail.code;return 3001==t||3002==t||3003==t||3005==t},e.prototype.isPlayFailed=function(e){var t=e.detail.code;return-2301==t||2101==t||2102==t},e.prototype.shouldRetryPublish=function(e){var t=e.detail.code;return 3001==t||3002==t||3003==t||3004==t||3005==t},e.prototype.isPublishFailed=function(e){var t=e.detail.code;return-1301==t||-1302==t||-1303==t||-1304==t||-1305==t||-1306==t||-1307==t||-1308==t||-1309==t||-1310==t||-1311==t},e.prototype.updateEvent=function(e){if(0==this.playerType){if(2004==e.detail.code)this.everSuccess?this.dataReport.eventEnd(this.playerSeq,"PlayRetry"):(this.everSuccess=!0,this.dataReport.eventStart(this.playerSeq,"PlayStat")),this.streamCenter.onPlayerStart(this.streamid,this.playerType);else if(2009==e.detail.code)this.streamCenter.onPlayerVideoSizeChanged(this.streamid);else if(this.shouldRetryPlay(e))this.dataReport.eventStart(this.playerSeq,"PlayRetry"),this.dataReport.addEventInfo(this.playerSeq,"PlayRetry","error_code",e.detail.code);else if(this.isPlayFailed(e)){this.logger.info("zp.ue.0 play error: "+this.streamid),this.resetPlayer();var t={errorCode:e.detail.code};this.dataReport.addEvent(this.playerSeq,"PlayError",t),this.streamCenter.onPlayerStop(this.streamid,this.playerType,e.detail.code)}this.everSuccess||this.dataReport.eventEnd(this.playerSeq,"PlayBegin")}else if(1==this.playerType){if(1002==e.detail.code)this.everSuccess?this.dataReport.eventEnd(this.playerSeq,"PublishRetry"):(this.everSuccess=!0,this.dataReport.eventStart(this.playerSeq,"PublishStat")),this.streamCenter.onPlayerStart(this.streamid,this.playerType);else if(this.shouldRetryPublish(e))this.dataReport.eventStart(this.playerSeq,"PublishRetry"),this.dataReport.addEventInfo(this.playerSeq,"PublishRetry","error_code",e.detail.code);else if(this.isPublishFailed(e)){this.logger.info("zp.ue.0 publish error: "+this.streamid),this.resetPlayer();var s={errorCode:e.detail.code};this.dataReport.addEvent(this.playerSeq,"PublishError",s),this.reportQualityStatics(),this.streamCenter.onPlayerStop(this.streamid,this.playerType,e.detail.code)}this.everSuccess||this.dataReport.eventEnd(this.playerSeq,"PublishBegin")}},e.prototype.updatePlayerNetStatus=function(e){var t={videoBitrate:e.detail.info.videoBitrate,audioBitrate:e.detail.info.audioBitrate,videoFPS:e.detail.info.videoFPS,videoHeight:e.detail.info.videoHeight,videoWidth:e.detail.info.videoWidth};if(this.playerInfo=t,1==this.playerType){var s={videoBitrate:e.detail.info.videoBitrate,audioBitrate:e.detail.info.audioBitrate,videoFPS:e.detail.info.videoFPS,videoGOP:e.detail.info.videoGOP,netSpeed:e.detail.info.netSpeed,netJitter:e.detail.info.netJitter,videoWidth:e.detail.info.videoWidth,videoHeight:e.detail.info.videoHeight};if(0==this.publishQualitySeq&&(this.publishQualitySeq=++this.streamCenter.eventSeq,this.dataReport.newReport(this.publishQualitySeq),this.dataReport.addMsgExt(this.publishQualitySeq,{stream:this.streamid})),this.dataReport.addEvent(this.publishQualitySeq,"PublishQuality",s),this.publishQualityCount+=1,this.publishQualityCount>=this.publishQulaityMaxCount)(new Date).getTime()-this.playerLogUploadTime>45e3&&(this.reportQualityStatics(),this.playerLogUploadTime=(new Date).getTime())}this.streamCenter.onPlayerQuality(this.streamid,t,this.playerType)},e.prototype.getCurrentPlayerUrl=function(){return this.urls[this.playUrlIndex%this.urls.length]},e.prototype.reportQualityStatics=function(){this.dataReport.uploadReport(this.publishQualitySeq,"WXPublishStateUpdate"),this.publishQualityCount=0,this.publishQualitySeq=0},e}();t.ZegoPlayWechat=i},function(e,t,s){"use strict";var r=this&&this.__assign||Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++)for(var i in t=arguments[s])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.log=e,this.dataStatistics={},this.logger=e}return e.prototype.newReport=function(e){this.dataStatistics[e]={abs_time:Date.now(),time_consumed:0,error:0,events:[]}},e.prototype.addMsgExt=function(e,t){this.dataStatistics[e]?this.dataStatistics[e].msg_ext=t:console.warn(e+" not exist")},e.prototype.eventStart=function(e,t){this.dataStatistics[e]?void 0!=this.dataStatistics[e].events?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),time_consumed:0}):this.logger.warn("zd.es.0 no events"):this.logger.warn("zd.es.0 no seq match")},e.prototype.eventEnd=function(e,t,s){if(this.dataStatistics[e]){var r=this.dataStatistics[e].events;if(r&&0!==r.length){for(var i=r.length-1;i>=0;i--)if(r[i].event==t&&r[i].time_consumed){r[i].time_consumed=Date.now()-r[i].abs_time;break}}else this.logger.info("zd.ee.0 no events")}else this.logger.info("zd.ee.0 no seq match")},e.prototype.eventEndWithMsg=function(e,t,s){if(this.dataStatistics[e]){var i=this.dataStatistics[e].events;if(i){for(var o=i.length-1;o>=0;o--)if(i[o].event==t&&i[o].time_consumed){i[o].time_consumed=Date.now()-i[o].abs_time,void 0==i[o].msg_ext&&(i[o].msg_ext={}),i[o].msg_ext=r({},s);break}}else this.logger.warn("zd.ee.0 no events")}else this.logger.warn("zd.ee.0 no seq match")},e.prototype.addEventInfo=function(e,t,s,r){if(this.dataStatistics[e]){var i=this.dataStatistics[e].events;if(void 0!=i){for(var o=i.length-1;o>=0;o--)if(i[o].event==t&&void 0!=i[o].time_consumed&&i[o].event==t&&void 0!=i[o].time_consumed){void 0==i[o].msg_ext&&(i[o].msg_ext={}),i[o].msg_ext[s]=r;break}}else this.logger.warn("zd.aei.0 no events")}else this.logger.warn("zd.aei.0 no seq match")},e.prototype.addEvent=function(e,t,s){this.dataStatistics[e]?this.dataStatistics[e].events&&(s?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),msg_ext:s}):this.dataStatistics[e].events.push({event:t,abs_time:Date.now()})):this.logger.warn("zd.ae.0 no seq match")},e.prototype.uploadReport=function(e,t){var s=this.dataStatistics[e];void 0!=s&&(s.itemtype=t,s.time_consumed=Date.now()-s.abs_time,this.logger.report(s),delete this.dataStatistics[e])},e}();t.ZegoDataReport=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.playerList={},this.publisherList={}}return e.prototype.setSessionInfo=function(e,t,s,r){},e}();t.ZegoStreamCenter=r},function(e,t,s){"use strict";var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])},function(e,t){function s(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var o=s(17),n=s(16),a=s(15),l=0,h=1,u=2,d=0,c=1,g=function(e){function t(t,s){var r=e.call(this,t,s)||this;return r.playerList={},r.playerCount=0,r.playingList=[],r.publishingList=[],r.eventSeq=0,r.streamEventMap={},r.playerWaitingList=[],r.playerStatistics={},r.logger=t,r.dataReport=new n.ZegoDataReport(r.logger),r}return i(t,e),t.prototype.updatePlayingState=function(e,t,s){void 0!=e&&(this.updateStreamState(e,s,t,this.playingList),s?(this.eventSeq+=1,this.streamEventMap[e]=this.eventSeq,this.dataReport.newReport(this.eventSeq),this.dataReport.eventStart(this.eventSeq,"GotPlayInfo")):this.reportPlayEvent(e))},t.prototype.updatePublishingState=function(e,t,s){void 0===t&&(t=""),void 0===s&&(s=!1),void 0!=e&&(this.updateStreamState(e,s,t,this.publishingList),s?(this.eventSeq+=1,this.streamEventMap[e]=this.eventSeq,this.dataReport.newReport(this.eventSeq),this.dataReport.eventStart(this.eventSeq,"GotPublishInfo")):this.reportPublishEvent(e))},t.prototype.updateStreamState=function(e,t,s,r){if(e)if(s&&"string"==typeof s||(s=""),1==t)r.push({streamid:e,params:s});else for(var i=0;i<r.length;i++)if(r[i].streamid==e){r.splice(i,1);break}},t.prototype.isPlaying=function(){return 0!=this.playingList.length},t.prototype.isPublishing=function(){return 0!=this.publishingList.length},t.prototype.startPlayingStream=function(e,t,s){this.logger.debug("zpc.sps.0 call");var r=this.streamEventMap[e];if(r){var i="";0==s?i="cdn":1==s&&(i="ultra_src"),this.dataReport.eventEndWithMsg(r,"GotPlayInfo",{type:i,urls:t})}return this.startPlayer(e,t,s,d)},t.prototype.startPlayer=function(e,t,s,r){var i=this.playerList[e];if(i)return!0;var o=[];r==d?o=this.playingList:r==c&&(o=this.publishingList);for(var n=!1,l="",h=0;h<o.length;h++)if(o[h].streamid==e){n=!0,l=o[h].params;break}if(!n)return this.logger.warn("zpc.sp.0 should not start"),!1;if((i=this.playerList[e]=new a.ZegoPlayWechat(this.logger,e,t,l,this.getReconnectLimit(s),this,s,r,this.dataReport)).playerSeq=this.streamEventMap[e],!i)return this.logger.info("zpc.sp.0 new player failed"),!1;++this.playerCount;var u=i.tryStartPlayer(0);return this.logger.debug("zpc.sp.0 call result:",u),u},t.prototype.stopPlayingStream=function(e){this.logger.debug("zpc.sps.1.0 call"),void 0!=e&&(this.stopPlayer(e),this.updatePlayingState(e))},t.prototype.stopPlayer=function(e){var t=this.playerList[e];t&&(t.stopPlayer(),delete this.playerList[e],--this.playerCount),this.logger.debug("zpc.sp.1.0 call success")},t.prototype.startPublishingStream=function(e,t,s){this.logger.debug("zpc.sps.1 call");var r=this.streamEventMap[e];if(r){var i="";0==s?i="cdn":1==s&&(i="ultra_src"),this.dataReport.eventEndWithMsg(r,"GotPublishInfo",{type:i,urls:t})}return this.startPlayer(e,t,s,c)},t.prototype.stopPublishingStream=function(e){this.logger.debug("zpc.sps.1.1 call"),void 0!=e&&(this.stopPlayer(e),this.updatePublishingState(e,"",!1))},t.prototype.updatePlayerState=function(e,t){var s=this.playerList[e];s?s.updateEvent(t):this.logger.warn("zpc.upe.1.0 no player "+e),this.logger.debug("zpc.upe.1.0 updatePlayerEvent success")},t.prototype.updatePlayerNetStatus=function(e,t){var s=this.playerList[e];s?s.updatePlayerNetStatus(t):this.logger.warn("zpc.upns.1.0 no player "+e),this.logger.debug("zpc.upns.1.0 updatePlayerNetStatus success")},t.prototype.reset=function(){this.logger.debug("zpc.r.0 call");for(var e=0;e<this.playingList.length;e++)this.stopPlayingStream(this.playingList[e]);for(var t=0;t<this.publishingList.length;t++)this.stopPublishingStream(this.publishingList[t]);this.playerCount=0,this.playerList={},this.playerWaitingList=[],this.playerStatistics={},this.streamEventMap={},this.logger.debug("zpc.r.0 call success")},t.prototype.reportPublishEvent=function(e,t){if(this.streamEventMap[e]){var s=this.streamEventMap[e];this.dataReport.addMsgExt(s,{stream:e,error:t}),this.dataReport.uploadReport(s,"WXPublishStream"),delete this.streamEventMap[e]}},t.prototype.reportPlayEvent=function(e,t){if(this.streamEventMap[e]){var s=this.streamEventMap[e];this.dataReport.addMsgExt(s,{stream:e,error:t}),this.dataReport.uploadReport(s,"WXPlayStream"),delete this.streamEventMap[e]}},t.prototype.onPlayStateUpdate=function(e,t,s){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,s){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onPlayerStreamUrlUpdate=function(e,t,s){},t.prototype.onVideoSizeChanged=function(e){},t.prototype.getReconnectLimit=function(e){return 1},t.prototype.onPlayerStart=function(e,t){this.logger.debug("ops.0 call"),t==d?this.onPlayStateUpdate(l,e,0):t==c&&this.onPublishStateUpdate(l,e,0)},t.prototype.onPlayerStop=function(e,t,s){this.logger.debug("ops.1 call"),t==d?(this.reportPlayEvent(e,s),this.logger.warn("ops.1 play error"),this.onPlayStateUpdate(h,e,s)):t==c&&(this.reportPublishEvent(e,s),this.logger.warn("ops.1 publish error"),this.onPublishStateUpdate(h,e,s))},t.prototype.onPlayerRetry=function(e,t){this.logger.debug("opr.0 call"),t==d?this.onPlayStateUpdate(u,e,0):t==c&&this.onPublishStateUpdate(u,e,0)},t.prototype.onPlayerQuality=function(e,t,s){s==d?this.onPlayQualityUpdate(e,t):s==c&&this.onPublishQualityUpdate(e,t)},t.prototype.onStreamUrlUpdate=function(e,t,s){this.logger.debug("opuu.0 call"),this.onPlayerStreamUrlUpdate(e,t,s)},t.prototype.onPlayerVideoSizeChanged=function(e){this.onVideoSizeChanged(e)},t}(o.ZegoStreamCenter);t.ZegoStreamCenterWechat=g},function(e,t,s){"use strict";var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])},function(e,t){function s(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var o=s(18),n=s(14),a=s(2),l=s(0),h=s(12),u=s(4),d=function(e){function t(){var t=e.call(this)||this;return t.preferPlaySourceType=l.ENUM_PLAY_SOURCE_TYPE.auto,t.preferPublishSourceType=l.ENUM_DISPATCH_TYPE.ultra,t.currentPlaySourceType=l.ENUM_DISPATCH_TYPE.cdn,t.mixStreamList={},t.ultraPlaySourceType="rtmp_v2",t.logger=new n.LoggerWechat,t.stateCenter=new u.StateCenter,t.streamCenter=new o.ZegoStreamCenterWechat(t.logger,t.stateCenter),t.init(),t}return i(t,e),t.prototype.getSocket=function(e){return new a.ZegoWebSocket(e)},t.prototype.setPreferPlaySourceType=function(e){return this.logger.debug("zc.p.sppst.0 call"),"number"!=typeof e||e!==l.ENUM_PLAY_SOURCE_TYPE.auto&&e!==l.ENUM_PLAY_SOURCE_TYPE.ultra?(this.logger.info("zc.p.sppst.0 param error"),!1):(this.preferPlaySourceType=e,this.logger.debug("zc.p.sppst.0 call success"),!0)},t.prototype.setPreferPublishSourceType=function(e,t){return this.logger.debug("zc.p.sppst.1 call"),"number"!=typeof e||e!==l.ENUM_DISPATCH_TYPE.cdn&&e!==l.ENUM_DISPATCH_TYPE.ultra&&e!==l.ENUM_DISPATCH_TYPE.customUrl?(this.logger.error("zc.p.sppst.1 param error"),!1):e!==l.ENUM_DISPATCH_TYPE.customUrl||t?(this.preferPublishSourceType=e,this.customCdnUrl=t,this.logger.debug("zc.p.sppst.1 call success"),!0):(this.logger.error("zc.p.sppst.1 param error"),!1)},t.prototype.startPlayingStream=function(e,t){return this.logger.debug("zc.p.sps.0 call"),e&&""!==e?this.stateCenter.isLogin()?(this.streamCenter.updatePlayingState(e,t,!0),this.streamCenter.isPublishing()?this.preferPublishSourceType==l.ENUM_DISPATCH_TYPE.cdn?this.startPlayingStreamFromCDN(e):this.startPlayingStreamFromBGP(e):this.preferPlaySourceType==l.ENUM_PLAY_SOURCE_TYPE.ultra?this.startPlayingStreamFromBGP(e):this.startPlayingStreamFromCDN(e)):(this.logger.info("zc.p.sps.0 not login"),!1):(this.logger.info("zc.p.sps.0 param error"),!1)},t.prototype.stopPlayingStream=function(e){if(this.logger.debug("zc.p.sps.1.0 call"),!e||""===e)return this.logger.info("zc.p.sps.1.0 param error"),!1;for(var t in this.streamCenter.stopPlayingStream(e),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[t]===e){delete this.stateCenter.streamUrlMap[t];break}return this.logger.debug("zc.p.sps.1.0 call success"),!0},t.prototype.startPublishingStream=function(e,t,s){if(void 0===t&&(t=""),void 0===s&&(s=""),this.logger.debug("zc.p.sps.1 call"),!e)return this.logger.error("zc.p.sps.1 param error"),!1;if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.1 not login"),!1;if(this.stateCenter.publishStreamList[e]={state:l.ENUM_PUBLISH_STREAM_STATE.waiting_url,extra_info:s},this.logger.info("zc.p.sps.0 fetch stream url"),this.streamCenter.updatePublishingState(e,t,!0),this.fetchPublishStreamUrl(e),this.streamCenter.isPlaying()&&this.preferPublishSourceType==l.ENUM_DISPATCH_TYPE.ultra&&this.currentPlaySourceType==l.ENUM_DISPATCH_TYPE.cdn)for(var r=0;r<this.streamCenter.playingList.length;r++){var i=this.streamCenter.playingList[r].streamid,o=this.streamCenter.playingList[r].params;this.stopPlayingStream(i),this.streamCenter.updatePlayingState(i,o,!0),this.startPlayingStreamFromBGP(i)}return!0},t.prototype.stopPublishingStream=function(e){return this.logger.debug("zc.p.sps.1.1 call"),e&&""!==e?(this.streamCenter.stopPublishingStream(e),this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].state>=l.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(e,l.ENUM_STREAM_SUB_CMD.liveEnd),delete this.stateCenter.publishStreamList[e]),this.stateCenter.streamUrlMap[e]&&delete this.stateCenter.streamUrlMap[e],this.logger.debug("zc.p.sps.1.1 call success"),!0):(this.logger.info("zc.p.sps.1.1 param error"),!1)},t.prototype.updatePlayerState=function(e,t){this.logger.debug("zc.p.upe.0 call"),this.streamCenter.updatePlayerState(e,t)},t.prototype.updatePlayerNetStatus=function(e,t){this.logger.debug("zc.p.upns.0 call"),this.streamCenter.updatePlayerNetStatus(e,t)},t.prototype.startPlayingMixStream=function(e,t){return this.logger.debug("zc.p.spms.0 call"),e&&""!==e?this.stateCenter.isLogin()?(this.streamCenter.updatePlayingState(e,t,!0),this.mixStreamList[e]={urltra_url_rtmp:null},this.fetchPlayStreamUrl(e,"rtmp_cdn"),this.logger.debug("zc.p.spms.0 call success"),!0):(this.logger.info("zc.p.spms.0 not login"),!1):(this.logger.info("zc.p.spms.0 param error"),!1)},t.prototype.stopPlayingMixStream=function(e){if(this.logger.debug("zc.p.spms.1 call"),!e||""===e)return this.logger.info("zc.p.spms.1 param error"),!1;for(var t in this.streamCenter.stopPlayingStream(e),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[t]===e){delete this.stateCenter.streamUrlMap[t];break}return delete this.mixStreamList[e],this.logger.debug("zc.p.spms.1 call success"),!0},t.prototype.startPlayingStreamFromCDN=function(e){this.logger.debug("zc.p.spsfc.0 call");for(var t=null,s=0;s<this.stateCenter.streamList.length;s++)if(this.stateCenter.streamList[s].stream_id===e){t=this.stateCenter.streamList[s].urls_rtmp||[];break}return!t||t.length<=0?(this.logger.error("zc.p.spsfc.0 cannot find stream url"),!1):(this.currentPlaySourceType=l.ENUM_DISPATCH_TYPE.cdn,this.logger.debug("zc.p.spsfc.0 play stream"),this.doPlayStream(e,t,this.currentPlaySourceType))},t.prototype.startPlayingStreamFromBGP=function(e){return this.currentPlaySourceType=l.ENUM_DISPATCH_TYPE.ultra,this.logger.info("zc.p.sps.0 fetch stream url"),this.fetchPlayStreamUrl(e,this.ultraPlaySourceType),!0},t.prototype.fetchPublishStreamUrl=function(e){var t=this;if(this.logger.debug("fpsu.0 call"),this.stateCenter.isLogin()){this.logger.info("fpsu.0 send fetch publish request");var s="";this.preferPublishSourceType==l.ENUM_DISPATCH_TYPE.cdn?s="cdn":this.preferPublishSourceType==l.ENUM_DISPATCH_TYPE.ultra&&(s="bgp");var r={stream_id:e,url_type:this.ultraPlaySourceType,publish_type:s,header_kvs:[{key:"grpc-metadata-push",value:this.customCdnUrl||""}]};this.socketCenter.registerRouter("stream_publish",function(e){t.handleFetchStreamPublishUrlRsp(e)});var i=this.socketCenter.sendMessage("stream_publish",r);-1==i?(this.onPublishStateUpdate(1,e,-1),this.streamCenter.stopPublishingStream(e)):this.stateCenter.streamUrlMap[i]=e,this.logger.debug("fpsu.0 call success")}else this.logger.error("fpsu.0 state error")},t.prototype.fetchPlayStreamUrl=function(e,t){var s=this;if(this.logger.debug("fsu.0 call"),this.stateCenter.isLogin()){this.logger.info("fsu.0 send fetch request");var r={stream_ids:[e],url_type:t};this.socketCenter.registerRouter("stream_url",function(e){s.handleFetchStreamUrlRsp(e)});var i=this.socketCenter.sendMessage("stream_url",r,void 0,function(e,t){s.stateCenter.streamUrlMap[t]?s.onPlayStateUpdate(1,s.stateCenter.streamUrlMap[t],-1):s.logger.info("fsu.0 already stop play")});-1==i?this.onPlayStateUpdate(1,e,-1):this.stateCenter.streamUrlMap[i]=e,this.logger.debug("fsu.0 call success")}else this.logger.info("fsu.0 state error")},t.prototype.updateStreamInfo=function(e,t,s,r){this.logger.debug("usi.0 call");var i="";void 0!=s&&"string"==typeof s&&(i=s);var o={stream_id:e,extra_info:i},n={sub_cmd:t,stream_msg:JSON.stringify(o)};this.socketCenter.registerRouter("stream",function(e){}),this.socketCenter.sendMessage("stream",n,void 0,r),this.logger.debug("usi.0 call success cmd "+t)},t.prototype.handleStreamUpdateRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){this.logger.debug("hsur.0 stream seq "+this.stateCenter.streamSeq+" server seq "+e.body.stream_seq),this.stateCenter.streamSeq=e.body.stream_seq;for(var t=0;t<e.body.stream_info.length;t++){var s=e.body.stream_info[t].stream_id;if(!this.stateCenter.publishStreamList[s])return void this.logger.info("hsur.0 stream is not exist");this.stateCenter.publishStreamList[s].state==l.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.stateCenter.publishStreamList[s].state=l.ENUM_PUBLISH_STREAM_STATE.publishing,this.onPublishStateUpdate(0,s,0))}}else this.logger.info("hsur.0 stream update error "+e.body.err_code);else this.logger.info("hsur.0 not login")},t.prototype.doPlayStream=function(e,t,s){return this.logger.debug("zc.p.dps.0 call"),!(!t||t.length<=0)&&(this.streamCenter.startPlayingStream(e,t,s),!0)},t.prototype.handleFetchStreamPublishUrlRsp=function(e){this.logger.debug("hfspur.0 call");var t=this.stateCenter.streamUrlMap[e.header.seq];if(t&&delete this.stateCenter.streamUrlMap[e.header.seq],0!==e.body.err_code)return this.logger.info("hfspur.0 server error=",e.body.err_code),void(this.stateCenter.publishStreamList[t]&&(this.onPublishStateUpdate(1,t,e.body.err_code+l.SERVER_ERROR_CODE),this.streamCenter.stopPublishingStream(t)));if(e.body.stream_url_info){var s=e.body.stream_url_info.stream_id,r=e.body.stream_url_info.urls_ws;if(!this.stateCenter.publishStreamList[s])return void this.logger.error("hfspur.0 cannot find stream");this.stateCenter.publishStreamList[s].url_rtmp=r,this.stateCenter.publishStreamList[s].state=l.ENUM_PUBLISH_STREAM_STATE.tryPublish,this.doPublishStream(s,r)}},t.prototype.handleFetchStreamUrlRsp=function(e){this.logger.debug("hfsur.0 call");var t=this.stateCenter.streamUrlMap[e.header.seq];if(t&&delete this.stateCenter.streamUrlMap[e.header.seq],0!==e.body.err_code)return this.logger.debug("hfsur.0 server error=",e.body.err_code),void this.onPlayStateUpdate(1,t,e.body.err_code+l.SERVER_ERROR_CODE);if(e.body.stream_url_infos&&e.body.stream_url_infos.length>0){for(var s=e.body.stream_url_infos[0].stream_id,r=e.body.stream_url_infos[0].urls_ws,i=this.currentPlaySourceType,o=!1,n=0;n<this.stateCenter.streamList.length;n++)if(this.stateCenter.streamList[n].stream_id==s){this.stateCenter.streamList[n].urltra_url_rtmp=r,o=!0;break}!o&&this.mixStreamList[s]&&(this.mixStreamList[s].urltra_url_rtmp=r,i=l.ENUM_DISPATCH_TYPE.cdn,o=!0),o||(this.logger.info("hfsur.0 cannot find streaminfo in existing stream list"),this.stateCenter.streamList.push({stream_id:s,urltra_url_rtmp:r})),this.doPlayStream(s,r,i)}this.logger.debug("hfsur.0 call success")},t.prototype.doPublishStream=function(e,t){return this.logger.debug("zc.p.dps.1 call"),!(!t||t.length<=0)&&(this.logger.info("zc.p.dps.1 streamid: "+e+"streamUrl: "+t),this.streamCenter.startPublishingStream(e,t,this.preferPublishSourceType),this.logger.debug("zc.p.dps.1 call success"),!0)},t.prototype.setCDNInfo=function(e,t){},t.prototype.loginBodyData=function(){return{id_name:this.stateCenter.idName,nick_name:this.stateCenter.nickName,role:this.stateCenter.role,token:this.stateCenter.token,version:l.PROTO_VERSION,room_name:this.stateCenter.roomid,user_state_flag:this.stateCenter.userStateUpdate?1:0,room_create_flag:this.stateCenter.roomCreateFlag,client_type:l.E_CLIENT_TYPE.ClientType_SmallPragram,third_token:this.stateCenter.third_token}},t.prototype.WebrtcOnPublishStateUpdateHandle=function(e,t,s){},t}(h.BaseCenter);t.ZegoClient=d}])});